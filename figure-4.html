<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title> 4 Figure 4 | CancerMHBs</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content=" 4 Figure 4 | CancerMHBs" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content=" 4 Figure 4 | CancerMHBs" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Zhiqiang Zhang,Yuyang Hong, Hai Fang, Jiantao Shi" />


<meta name="date" content="2024-06-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="figure-3.html"/>
<link rel="next" href="figure-5.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://jiantaoshi.github.io/cancermhaps/index.html">CancerMHBs</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Figure 1</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#cancer-mhb-calling"><i class="fa fa-check"></i><b>1.1</b> Cancer MHB Calling</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#c-e.-mhb-annotation"><i class="fa fa-check"></i><b>1.2</b> (C-E). MHB annotation</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#f.-mhb-map"><i class="fa fa-check"></i><b>1.3</b> (F). MHB Map</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#g.-cancer-mhbs-vs-normal-mhbs"><i class="fa fa-check"></i><b>1.4</b> (G). Cancer MHBs vs Normal MHBs</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#h.-correlation-of-methylation-on-the-same-mhb"><i class="fa fa-check"></i><b>1.5</b> (H). Correlation of methylation on the same MHB</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#i.-enrichment-of-mhbs-in-genomic-features."><i class="fa fa-check"></i><b>1.6</b> (I). Enrichment of MHBs in genomic features.</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="figure-2.html"><a href="figure-2.html"><i class="fa fa-check"></i><b>2</b> Figure 2</a>
<ul>
<li class="chapter" data-level="2.1" data-path="figure-2.html"><a href="figure-2.html#a.-cancer-mhbs-and-open-chromatin"><i class="fa fa-check"></i><b>2.1</b> (A). Cancer MHBs and open chromatin</a></li>
<li class="chapter" data-level="2.2" data-path="figure-2.html"><a href="figure-2.html#b.-cancer-mhbs-and-dnam-features"><i class="fa fa-check"></i><b>2.2</b> (B). Cancer MHBs and DNAm features</a></li>
<li class="chapter" data-level="2.3" data-path="figure-2.html"><a href="figure-2.html#c-d.-enrichment-of-cancer-mhbs-in-dnam-feature-lola"><i class="fa fa-check"></i><b>2.3</b> (C-D). Enrichment of Cancer MHBs in DNAm feature (LOLA)</a></li>
<li class="chapter" data-level="2.4" data-path="figure-2.html"><a href="figure-2.html#e.-genomic-features-with-mhbs-in-open-chromatin"><i class="fa fa-check"></i><b>2.4</b> (E). Genomic features with MHBs in open chromatin</a></li>
<li class="chapter" data-level="2.5" data-path="figure-2.html"><a href="figure-2.html#f.-enrichment-of-mhbs-in-chia-pet-in-a-disease-status-specific-manner."><i class="fa fa-check"></i><b>2.5</b> (F). Enrichment of MHBs in ChIA-PET in a disease status-specific manner.</a></li>
<li class="chapter" data-level="2.6" data-path="figure-2.html"><a href="figure-2.html#g.-enrichment-of-chia-pet-tags-in-mhbs."><i class="fa fa-check"></i><b>2.6</b> (G). Enrichment of ChIA-PET tags in MHBs.</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="figure-3.html"><a href="figure-3.html"><i class="fa fa-check"></i><b>3</b> Figure 3</a>
<ul>
<li class="chapter" data-level="3.1" data-path="figure-3.html"><a href="figure-3.html#a.-mhb-vs-dmr"><i class="fa fa-check"></i><b>3.1</b> (A). MHB vs DMR</a></li>
<li class="chapter" data-level="3.2" data-path="figure-3.html"><a href="figure-3.html#b-c.-enrichment-of-cancer-mhbs-in-dmr-lola"><i class="fa fa-check"></i><b>3.2</b> (B-C). Enrichment of Cancer MHBs in DMR (LOLA)</a></li>
<li class="chapter" data-level="3.3" data-path="figure-3.html"><a href="figure-3.html#d-e.-escc-dnam-and-rna-profiles-gse149608"><i class="fa fa-check"></i><b>3.3</b> (D-E). ESCC DNAm and RNA profiles (GSE149608)</a></li>
<li class="chapter" data-level="3.4" data-path="figure-3.html"><a href="figure-3.html#f-g.-tf-activities"><i class="fa fa-check"></i><b>3.4</b> (F-G). TF activities</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="figure-4.html"><a href="figure-4.html"><i class="fa fa-check"></i><b>4</b> Figure 4</a>
<ul>
<li class="chapter" data-level="4.1" data-path="figure-4.html"><a href="figure-4.html#b.-crc-single-cell-mhap"><i class="fa fa-check"></i><b>4.1</b> (B). CRC single-cell mHap</a></li>
<li class="chapter" data-level="4.2" data-path="figure-4.html"><a href="figure-4.html#c.-crc-single-cell-mhbs"><i class="fa fa-check"></i><b>4.2</b> (C). CRC single-cell MHBs</a></li>
<li class="chapter" data-level="4.3" data-path="figure-4.html"><a href="figure-4.html#d-single-cell-mhb-vs-bulk-mhb"><i class="fa fa-check"></i><b>4.3</b> (D) Single cell MHB vs bulk MHB</a></li>
<li class="chapter" data-level="4.4" data-path="figure-4.html"><a href="figure-4.html#e.-association-between-gene-expression-and-the-present-of-mhbs-in-promoter-regions."><i class="fa fa-check"></i><b>4.4</b> (E). Association between gene expression and the present of MHBs in promoter regions.</a></li>
<li class="chapter" data-level="4.5" data-path="figure-4.html"><a href="figure-4.html#f.-association-of-gene-expression-and-methylation-levels-of-mhb-regions"><i class="fa fa-check"></i><b>4.5</b> (F). Association of gene expression and methylation levels of MHB regions</a></li>
<li class="chapter" data-level="4.6" data-path="figure-4.html"><a href="figure-4.html#i-j.-mhbs-and-dysregulation-of-gene-expression-in-crc."><i class="fa fa-check"></i><b>4.6</b> (I-J). MHBs and dysregulation of gene expression in CRC.</a></li>
<li class="chapter" data-level="4.7" data-path="figure-4.html"><a href="figure-4.html#k.-tcga-coad-dataset-validation"><i class="fa fa-check"></i><b>4.7</b> (K). TCGA-COAD dataset Validation</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="figure-5.html"><a href="figure-5.html"><i class="fa fa-check"></i><b>5</b> Figure 5</a>
<ul>
<li class="chapter" data-level="5.1" data-path="figure-5.html"><a href="figure-5.html#a-b.-enrichment-of-dmr-or-mhb-associated-genes-in-degs"><i class="fa fa-check"></i><b>5.1</b> (A-B). Enrichment of DMR or MHB-associated genes in DEGs</a></li>
<li class="chapter" data-level="5.2" data-path="figure-5.html"><a href="figure-5.html#c.-pathway-enrichment-of-mhb-associated-genes-in-pan-cancer"><i class="fa fa-check"></i><b>5.2</b> (C). Pathway enrichment of MHB-associated genes in pan-cancer</a></li>
<li class="chapter" data-level="5.3" data-path="figure-5.html"><a href="figure-5.html#e.-kegg-pathway-crosstalk-analysis-for-pan-cancer"><i class="fa fa-check"></i><b>5.3</b> (E). KEGG Pathway crosstalk analysis for pan-cancer</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="figure-6.html"><a href="figure-6.html"><i class="fa fa-check"></i><b>6</b> Figure 6</a>
<ul>
<li class="chapter" data-level="6.1" data-path="figure-6.html"><a href="figure-6.html#a-b.-aging-associate-with-the-mhb"><i class="fa fa-check"></i><b>6.1</b> (A-B). Aging associate with the MHB</a></li>
<li class="chapter" data-level="6.2" data-path="figure-6.html"><a href="figure-6.html#c.-aging-associated-mhb-in-tcga-dataset"><i class="fa fa-check"></i><b>6.2</b> (C). Aging associated mhb in TCGA dataset</a></li>
<li class="chapter" data-level="6.3" data-path="figure-6.html"><a href="figure-6.html#d-m-aging-associated-mhb-functions-in-early-cancer-detection-hm450k"><i class="fa fa-check"></i><b>6.3</b> (D-M) Aging associated MHB functions in Early Cancer Detection (HM450K)</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://jiantaoshi.github.io/cancermhaps/index.html" target="blank"> The mHap map of cancers</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">CancerMHBs</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="figure-4" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number"> 4</span> Figure 4<a href="figure-4.html#figure-4" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><img src="Data/Figures/Figure4.png" width="80%" style="display: block; margin: auto;" />
<strong>Figure. 4 Validation of cancer MHBs and the associated regulatory role using single-cell data.</strong> (A) Schematic of single-cell DNA methylation haplotype (sc-mHap). Assuming one chromosome from a single-cell can be described as two mHaps, CpG methylation was binarized as methylated (mean &gt; 0.9) or un-methylation (mean &lt; 0.1), which were converted to sc-mHaps (upper panel). The bottom panel illustrates an example set of DNA methylation haplotypes across 15 single cells. (B) An example of COAD MHB that was also identified in region (chr1:3,229,375-3,230,473) using CRC single-cell data. (C) Venn diagram showing numbers of overlapping MHBs which were identified from single-cells in different types of samples. (D) Enrichment of single-cell MHBs from primary tumor (PT) across MHBs identified from bulk samples from 11 cancer types. Enrichment was tested LOLA package using MHBs from all cancer types as background. (E) Association between gene expression and presence of MHBs in promoter regions. For each single cell, promoters were categorized into three groups: high methylation (mean &gt; 0.8), intermediate methylation (mean 0.2-0.8), and low methylation (mean &lt; 0.2). Within each group, the expression of genes with MHBs in their promoters was compared to those without MHBs. Statistical significance was evaluated using the Wilcoxon rank-sum test. (F) Association of gene expression and methylation levels of MHB regions. For each single cell, promoters were categorized into two groups: intermediate methylation (mean 0.2-0.8), and low methylation (mean &lt; 0.2). Within each group, genes with MHBs were further divided into two sub-groups according to the methylation levels in MHB regions. Promoters with high methylation (mean &gt; 0.8) were removed due to the small number of genes with MHBs. Statistical significance was evaluated using the Wilcoxon rank-sum test. (G) Association of MHBs and dysregulation of gene expression in CRC. The DEGs (log2FC &gt; =1 &amp; FDR &lt; 0.05) and differentially methylated promoters (Δbeta &gt; 0.1 &amp; FDR &lt; 0.05) were identified using the Wilcoxon rank-sum test. Genes without DMPs were used to construct a 2x2 contingency table that separates each gene into one of four categories based on two factors, i.e., status of MHB and differential expression. Statistical significance was evaluated by Fisher’s exact test. (H) Venn diagram showing the number of up-regulated genes in primary tumor and lymph node compared to normal tissues that harbor MHBs but lack DMRs in the promoter regions. (I) Pathway enrichment of 42 shared MHB-related genes in PT and LN. The online tool in MSigDB was used and top 3 hallmark pathways were shown. (J) A heatmap shows the mean methylation and expression of 42 shared genes that also contains MHBs across single cell. The genes annotated in MYC targets and G2M checkpoint pathways were colored in red. (K) The DNA methylation and gene expression profiles of the 10 genes highlighted in panel J were validated using the TCGA-COAD dataset at different pathological stages. (L) The Kaplan-Meier survival curves comparing disease free survival (DFS) between patient subgroups stratified by the high/low expression (median cutoff) of CBX3 gene in TCGA-COAD dataset. Statistical significance is calculated using log rank test. P value was calculated using the log-rank test, and the HRs were calculated using univariable Cox regression analysis. Promoters were defined as ± 1 kb region around the transcription start site (TSS).</p>
<div id="b.-crc-single-cell-mhap" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> (B). CRC single-cell mHap<a href="figure-4.html#b.-crc-single-cell-mhap" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb24-1"><a href="figure-4.html#cb24-1" tabindex="-1"></a><span class="co"># The CRC single cell mHap visualization was performed by mHapSc (https://github.com/yoyoong/mHapSc)</span></span>
<span id="cb24-2"><a href="figure-4.html#cb24-2" tabindex="-1"></a><span class="co"># ============ shell command =============</span></span>
<span id="cb24-3"><a href="figure-4.html#cb24-3" tabindex="-1"></a><span class="ex">java</span> <span class="at">-jar</span> mHapSc-1.0-jar-with-dependencies.jar R2 <span class="at">-mhapPath</span> CRC_hg19.mhap.gz <span class="at">-cpgPath</span> hg19_CpG.gz <span class="dt">\</span></span>
<span id="cb24-4"><a href="figure-4.html#cb24-4" tabindex="-1"></a>                                                  <span class="at">-region</span> chr1:3229375-3230473 <span class="at">-outputDir</span> outputDir <span class="dt">\</span></span>
<span id="cb24-5"><a href="figure-4.html#cb24-5" tabindex="-1"></a>                                                  <span class="at">-tag</span> CRC_hg19 <span class="at">-mhapView</span> </span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-45"></span>
<img src="Data/Figures/Fig4/Fig4.B.png" alt="Fig4.B" width="60%" id="fig-unnamed-chunk-45-1" />
<p class="caption">
 4.1: Fig4.B
</p>
</div>
</div>
<div id="c.-crc-single-cell-mhbs" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> (C). CRC single-cell MHBs<a href="figure-4.html#c.-crc-single-cell-mhbs" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb25-1"><a href="figure-4.html#cb25-1" tabindex="-1"></a><span class="co"># CRC single cell MHB calling.</span></span>
<span id="cb25-2"><a href="figure-4.html#cb25-2" tabindex="-1"></a><span class="co"># ============ shell command ============= </span></span>
<span id="cb25-3"><a href="figure-4.html#cb25-3" tabindex="-1"></a><span class="co"># Input</span></span>
<span id="cb25-4"><a href="figure-4.html#cb25-4" tabindex="-1"></a><span class="va">mhap</span><span class="op">=</span>CRC_GSE97693.mhap.gz</span>
<span id="cb25-5"><a href="figure-4.html#cb25-5" tabindex="-1"></a><span class="va">bed</span><span class="op">=</span>hg19_1000CpG.bed</span>
<span id="cb25-6"><a href="figure-4.html#cb25-6" tabindex="-1"></a><span class="va">hg19_CpG</span><span class="op">=</span>hg19_CpG.gz</span>
<span id="cb25-7"><a href="figure-4.html#cb25-7" tabindex="-1"></a><span class="co"># call MHB</span></span>
<span id="cb25-8"><a href="figure-4.html#cb25-8" tabindex="-1"></a><span class="va">binary</span><span class="op">=</span>mHapSc-1.0-jar-with-dependencies.jar</span>
<span id="cb25-9"><a href="figure-4.html#cb25-9" tabindex="-1"></a><span class="va">outputDir</span><span class="op">=</span>MHB/CRC</span>
<span id="cb25-10"><a href="figure-4.html#cb25-10" tabindex="-1"></a></span>
<span id="cb25-11"><a href="figure-4.html#cb25-11" tabindex="-1"></a><span class="co"># All CRC single cell</span></span>
<span id="cb25-12"><a href="figure-4.html#cb25-12" tabindex="-1"></a><span class="va">bcFile</span><span class="op">=</span>scMHB_GSE97693/Anno/GSE97693_scMethyl_tumor_id.txt     <span class="co">#cell barcode</span></span>
<span id="cb25-13"><a href="figure-4.html#cb25-13" tabindex="-1"></a><span class="va">$java8</span> <span class="at">-jar</span> <span class="va">$binary</span> MHBDiscovery <span class="at">-mHapPath</span> <span class="va">$mhap</span> <span class="at">-bedFile</span> <span class="va">$bed</span> <span class="dt">\</span></span>
<span id="cb25-14"><a href="figure-4.html#cb25-14" tabindex="-1"></a>          <span class="at">-cpgPath</span> <span class="va">$hg19_CpG</span>  <span class="at">-bcFile</span> <span class="va">$bcFile</span> <span class="at">-window</span> 5 <span class="at">-r2</span> 0.5 <span class="at">-pvalue</span> 0.05 <span class="dt">\</span></span>
<span id="cb25-15"><a href="figure-4.html#cb25-15" tabindex="-1"></a>          <span class="at">-outputDir</span> <span class="va">$outputDir</span> <span class="at">-tag</span> CRC_Tumor_MHB </span>
<span id="cb25-16"><a href="figure-4.html#cb25-16" tabindex="-1"></a><span class="co"># Normal</span></span>
<span id="cb25-17"><a href="figure-4.html#cb25-17" tabindex="-1"></a><span class="va">bcFile</span><span class="op">=</span>scMHB_GSE97693/Anno/GSE97693_scMethyl_NC_id.txt</span>
<span id="cb25-18"><a href="figure-4.html#cb25-18" tabindex="-1"></a><span class="va">$java8</span> <span class="at">-jar</span> <span class="va">$binary</span> MHBDiscovery <span class="at">-mHapPath</span> <span class="va">$mhap</span> <span class="at">-bedFile</span> <span class="va">$bed</span> <span class="dt">\</span></span>
<span id="cb25-19"><a href="figure-4.html#cb25-19" tabindex="-1"></a>          <span class="at">-cpgPath</span> <span class="va">$hg19_CpG</span>  <span class="at">-bcFile</span> <span class="va">$bcFile</span> <span class="at">-window</span> 5 <span class="at">-r2</span> 0.5 <span class="at">-pvalue</span> 0.05 <span class="dt">\</span></span>
<span id="cb25-20"><a href="figure-4.html#cb25-20" tabindex="-1"></a>          <span class="at">-outputDir</span> <span class="va">$outputDir</span> <span class="at">-tag</span> CRC_MHB_NC</span>
<span id="cb25-21"><a href="figure-4.html#cb25-21" tabindex="-1"></a><span class="co"># PT</span></span>
<span id="cb25-22"><a href="figure-4.html#cb25-22" tabindex="-1"></a><span class="va">bcFile</span><span class="op">=</span>scMHB_GSE97693/Anno/GSE97693_scMethyl_PT_id.txt</span>
<span id="cb25-23"><a href="figure-4.html#cb25-23" tabindex="-1"></a><span class="va">$java8</span> <span class="at">-jar</span> <span class="va">$binary</span> MHBDiscovery <span class="at">-mHapPath</span> <span class="va">$mhap</span> <span class="at">-bedFile</span> <span class="va">$bed</span> <span class="dt">\</span></span>
<span id="cb25-24"><a href="figure-4.html#cb25-24" tabindex="-1"></a>          <span class="at">-cpgPath</span> <span class="va">$hg19_CpG</span>  <span class="at">-bcFile</span> <span class="va">$bcFile</span> <span class="at">-window</span> 5 <span class="at">-r2</span> 0.5 <span class="dt">\</span></span>
<span id="cb25-25"><a href="figure-4.html#cb25-25" tabindex="-1"></a>          <span class="at">-pvalue</span> 0.05 <span class="at">-outputDir</span> <span class="va">$outputDir</span> <span class="at">-tag</span> CRC_MHB_PT</span>
<span id="cb25-26"><a href="figure-4.html#cb25-26" tabindex="-1"></a><span class="co"># LN</span></span>
<span id="cb25-27"><a href="figure-4.html#cb25-27" tabindex="-1"></a><span class="va">bcFile</span><span class="op">=</span>scMHB_GSE97693/Anno/GSE97693_scMethyl_LN_id.txt</span>
<span id="cb25-28"><a href="figure-4.html#cb25-28" tabindex="-1"></a><span class="va">$java8</span> <span class="at">-jar</span> <span class="va">$binary</span> MHBDiscovery <span class="at">-mHapPath</span> <span class="va">$mhap</span> <span class="at">-bedFile</span> <span class="va">$bed</span> <span class="dt">\</span></span>
<span id="cb25-29"><a href="figure-4.html#cb25-29" tabindex="-1"></a>          <span class="at">-cpgPath</span> <span class="va">$hg19_CpG</span>  <span class="at">-bcFile</span> <span class="va">$bcFile</span>  <span class="at">-window</span> 5 <span class="at">-r2</span> 0.5 <span class="at">-pvalue</span> 0.05 <span class="dt">\</span></span>
<span id="cb25-30"><a href="figure-4.html#cb25-30" tabindex="-1"></a>          <span class="at">-outputDir</span> <span class="va">$outputDir</span> <span class="at">-tag</span> CRC_MHB_LN</span>
<span id="cb25-31"><a href="figure-4.html#cb25-31" tabindex="-1"></a><span class="co"># ML</span></span>
<span id="cb25-32"><a href="figure-4.html#cb25-32" tabindex="-1"></a><span class="va">bcFile</span><span class="op">=</span>scMHB_GSE97693/Anno/GSE97693_scMethyl_ML_id.txt</span>
<span id="cb25-33"><a href="figure-4.html#cb25-33" tabindex="-1"></a><span class="va">$java8</span> <span class="at">-jar</span> <span class="va">$binary</span> MHBDiscovery <span class="at">-mHapPath</span> <span class="va">$mhap</span> <span class="at">-bedFile</span> <span class="va">$bed</span> <span class="dt">\</span></span>
<span id="cb25-34"><a href="figure-4.html#cb25-34" tabindex="-1"></a>          <span class="at">-cpgPath</span> <span class="va">$hg19_CpG</span>  <span class="at">-bcFile</span> <span class="va">$bcFile</span> <span class="at">-window</span> 5 <span class="at">-r2</span> 0.5 <span class="at">-pvalue</span> 0.05 <span class="dt">\</span></span>
<span id="cb25-35"><a href="figure-4.html#cb25-35" tabindex="-1"></a>          <span class="at">-outputDir</span> <span class="va">$outputDir</span> <span class="at">-tag</span> CRC_MHB_ML</span>
<span id="cb25-36"><a href="figure-4.html#cb25-36" tabindex="-1"></a><span class="co"># MP</span></span>
<span id="cb25-37"><a href="figure-4.html#cb25-37" tabindex="-1"></a><span class="va">bcFile</span><span class="op">=</span>scMHB_GSE97693/Anno/GSE97693_scMethyl_MP_id.txt</span>
<span id="cb25-38"><a href="figure-4.html#cb25-38" tabindex="-1"></a><span class="va">$java8</span> <span class="at">-jar</span> <span class="va">$binary</span> MHBDiscovery <span class="at">-mHapPath</span> <span class="va">$mhap</span> <span class="at">-bedFile</span> <span class="va">$bed</span> <span class="dt">\</span></span>
<span id="cb25-39"><a href="figure-4.html#cb25-39" tabindex="-1"></a>          <span class="at">-cpgPath</span> <span class="va">$hg19_CpG</span>  <span class="at">-bcFile</span> <span class="va">$bcFile</span> <span class="at">-window</span> 5 <span class="at">-r2</span> 0.5 <span class="at">-pvalue</span> 0.05 <span class="dt">\</span></span>
<span id="cb25-40"><a href="figure-4.html#cb25-40" tabindex="-1"></a>          <span class="at">-outputDir</span> <span class="va">$outputDir</span> <span class="at">-tag</span> CRC_MHB_MP</span>
<span id="cb25-41"><a href="figure-4.html#cb25-41" tabindex="-1"></a><span class="co"># veen diagram (interveen)</span></span>
<span id="cb25-42"><a href="figure-4.html#cb25-42" tabindex="-1"></a><span class="ex">intervene</span> venn <span class="at">-i</span> <span class="va">$outputDir</span>/<span class="pp">*</span>bed <span class="at">--output</span> MHB_venn</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-47"></span>
<img src="Data/Figures/Fig4/Fig4.C.png" alt="Fig4.C" width="80%" id="fig-unnamed-chunk-47-1" />
<p class="caption">
 4.2: Fig4.C
</p>
</div>
</div>
<div id="d-single-cell-mhb-vs-bulk-mhb" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> (D) Single cell MHB vs bulk MHB<a href="figure-4.html#d-single-cell-mhb-vs-bulk-mhb" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="figure-4.html#cb26-1" tabindex="-1"></a><span class="co"># Enrichment of single-cell MHBs from primary tumor (PT) across MHBs identified from bulk samples from 11 cancer types.</span></span>
<span id="cb26-2"><a href="figure-4.html#cb26-2" tabindex="-1"></a><span class="co">#LOLA enrichment</span></span>
<span id="cb26-3"><a href="figure-4.html#cb26-3" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;LOLA&quot;</span>)</span>
<span id="cb26-4"><a href="figure-4.html#cb26-4" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb26-5"><a href="figure-4.html#cb26-5" tabindex="-1"></a>scMHB_Tumor<span class="ot">=</span><span class="st">&quot;Data/Processed_data/MHB/singlecell/CRC_MHB_PT.bed&quot;</span></span>
<span id="cb26-6"><a href="figure-4.html#cb26-6" tabindex="-1"></a>background<span class="ot">=</span><span class="st">&quot;Data/Processed_data/MHB/MHB_11_cancers_clusters.bed&quot;</span></span>
<span id="cb26-7"><a href="figure-4.html#cb26-7" tabindex="-1"></a>mhb<span class="ot">=</span><span class="fu">readBed</span>(scMHB_Tumor)</span>
<span id="cb26-8"><a href="figure-4.html#cb26-8" tabindex="-1"></a><span class="co"># Universe_Sets Background</span></span>
<span id="cb26-9"><a href="figure-4.html#cb26-9" tabindex="-1"></a>universe_set<span class="ot">=</span><span class="fu">readBed</span>(background)</span>
<span id="cb26-10"><a href="figure-4.html#cb26-10" tabindex="-1"></a><span class="co"># regionDB</span></span>
<span id="cb26-11"><a href="figure-4.html#cb26-11" tabindex="-1"></a>states<span class="ot">=</span><span class="fu">loadRegionDB</span>(<span class="st">&quot;Data/Processed_data/MHB/singlecell/scLOLA/&quot;</span>)</span>
<span id="cb26-12"><a href="figure-4.html#cb26-12" tabindex="-1"></a><span class="co"># Runing LOLA</span></span>
<span id="cb26-13"><a href="figure-4.html#cb26-13" tabindex="-1"></a>locResults <span class="ot">=</span> <span class="fu">runLOLA</span>(mhb, universe_set, states, <span class="at">cores=</span><span class="dv">10</span>) </span>
<span id="cb26-14"><a href="figure-4.html#cb26-14" tabindex="-1"></a>CI <span class="ot">&lt;-</span> locResults <span class="sc">%&gt;%</span> <span class="fu">select</span>(support,b,c,d) <span class="sc">%&gt;%</span> <span class="fu">apply</span>(<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb26-15"><a href="figure-4.html#cb26-15" tabindex="-1"></a>               CI.low <span class="ot">&lt;-</span>  <span class="fu">matrix</span>(x,<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">nrow=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">fisher.test</span>() <span class="sc">%&gt;%</span> broom<span class="sc">::</span><span class="fu">tidy</span>() <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">3</span>)</span>
<span id="cb26-16"><a href="figure-4.html#cb26-16" tabindex="-1"></a>               CI.high <span class="ot">&lt;-</span>  <span class="fu">matrix</span>(x,<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">nrow=</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">fisher.test</span>() <span class="sc">%&gt;%</span> broom<span class="sc">::</span><span class="fu">tidy</span>() <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">4</span>)</span>
<span id="cb26-17"><a href="figure-4.html#cb26-17" tabindex="-1"></a>              <span class="fu">return</span>(<span class="fu">c</span>(CI.low,CI.high))</span>
<span id="cb26-18"><a href="figure-4.html#cb26-18" tabindex="-1"></a>               }) <span class="sc">%&gt;%</span> <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;CI.low&quot;</span>,<span class="st">&quot;CI.high&quot;</span>))</span>
<span id="cb26-19"><a href="figure-4.html#cb26-19" tabindex="-1"></a>locResults <span class="ot">&lt;-</span> locResults <span class="sc">%&gt;%</span> <span class="fu">cbind</span>(CI) <span class="sc">%&gt;%</span> </span>
<span id="cb26-20"><a href="figure-4.html#cb26-20" tabindex="-1"></a>                        <span class="fu">mutate</span>(<span class="at">OVR=</span><span class="dv">100</span><span class="sc">*</span><span class="fu">round</span>(support<span class="sc">/</span>size,<span class="dv">4</span>),</span>
<span id="cb26-21"><a href="figure-4.html#cb26-21" tabindex="-1"></a>                               <span class="at">logFDR=</span><span class="fu">ifelse</span>(qValue<span class="sc">==</span><span class="dv">0</span>,<span class="dv">300</span>,<span class="sc">-</span><span class="fu">log10</span>(qValue)),</span>
<span id="cb26-22"><a href="figure-4.html#cb26-22" tabindex="-1"></a>                               <span class="at">filename=</span><span class="fu">fct_rev</span>(<span class="fu">fct_inorder</span>(<span class="fu">str_split_i</span>(filename,<span class="st">&quot;[_.]&quot;</span>,<span class="at">i=</span><span class="dv">2</span>))))</span>
<span id="cb26-23"><a href="figure-4.html#cb26-23" tabindex="-1"></a><span class="co"># PLOT</span></span>
<span id="cb26-24"><a href="figure-4.html#cb26-24" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file=</span><span class="st">&quot;Data/Figures/Fig4/Fig4.D.pdf&quot;</span>,<span class="at">width=</span><span class="dv">8</span>,<span class="at">height=</span><span class="dv">5</span>)</span>
<span id="cb26-25"><a href="figure-4.html#cb26-25" tabindex="-1"></a>p<span class="ot">&lt;-</span> <span class="fu">ggplot</span>(locResults,<span class="fu">aes</span>(<span class="at">x=</span>oddsRatio,<span class="at">y=</span>filename,<span class="at">col=</span>logFDR)) <span class="sc">+</span> </span>
<span id="cb26-26"><a href="figure-4.html#cb26-26" tabindex="-1"></a>        <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size=</span>OVR,<span class="at">col=</span>logFDR),<span class="at">shape=</span><span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb26-27"><a href="figure-4.html#cb26-27" tabindex="-1"></a>        <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmax =</span> CI.high, <span class="at">xmin =</span> CI.low), <span class="at">height =</span> <span class="dv">0</span>,<span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb26-28"><a href="figure-4.html#cb26-28" tabindex="-1"></a>        <span class="fu">scale_color_gradient2</span>(<span class="at">midpoint=</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">max</span>(locResults<span class="sc">$</span>logFDR),<span class="at">space =</span><span class="st">&quot;Lab&quot;</span>,</span>
<span id="cb26-29"><a href="figure-4.html#cb26-29" tabindex="-1"></a>                              <span class="at">low=</span><span class="st">&quot;steelblue&quot;</span>,<span class="at">mid=</span><span class="st">&quot;orange&quot;</span>,<span class="at">high=</span><span class="st">&quot;firebrick&quot;</span>) <span class="sc">+</span> </span>
<span id="cb26-30"><a href="figure-4.html#cb26-30" tabindex="-1"></a>        <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="dv">1</span>),<span class="at">color=</span><span class="st">&quot;gray&quot;</span>,<span class="at">linetype=</span><span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb26-31"><a href="figure-4.html#cb26-31" tabindex="-1"></a>        <span class="fu">scale_x_continuous</span>(<span class="at">limits=</span><span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">3.2</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">3.5</span>, <span class="fl">0.5</span>))<span class="sc">+</span></span>
<span id="cb26-32"><a href="figure-4.html#cb26-32" tabindex="-1"></a>        <span class="fu">xlab</span>(<span class="st">&#39;Odds Ratio&#39;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot; &quot;</span>) <span class="sc">+</span> </span>
<span id="cb26-33"><a href="figure-4.html#cb26-33" tabindex="-1"></a>        <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb26-34"><a href="figure-4.html#cb26-34" tabindex="-1"></a>        <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;top&quot;</span>,</span>
<span id="cb26-35"><a href="figure-4.html#cb26-35" tabindex="-1"></a>              <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>,<span class="at">color=</span><span class="st">&quot;black&quot;</span>),</span>
<span id="cb26-36"><a href="figure-4.html#cb26-36" tabindex="-1"></a>              <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">20</span>,<span class="at">color=</span><span class="st">&quot;black&quot;</span>),</span>
<span id="cb26-37"><a href="figure-4.html#cb26-37" tabindex="-1"></a>              <span class="at">axis.ticks.length=</span><span class="fu">unit</span>(<span class="fl">0.2</span>, <span class="st">&quot;cm&quot;</span>) )</span>
<span id="cb26-38"><a href="figure-4.html#cb26-38" tabindex="-1"></a></span>
<span id="cb26-39"><a href="figure-4.html#cb26-39" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb26-40"><a href="figure-4.html#cb26-40" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-49"></span>
<img src="Data/Figures/Fig4/Fig4.D.png" alt="Fig4.D" width="80%" id="fig-unnamed-chunk-49-1" />
<p class="caption">
 4.3: Fig4.D
</p>
</div>
</div>
<div id="e.-association-between-gene-expression-and-the-present-of-mhbs-in-promoter-regions." class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> (E). Association between gene expression and the present of MHBs in promoter regions.<a href="figure-4.html#e.-association-between-gene-expression-and-the-present-of-mhbs-in-promoter-regions." class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="figure-4.html#cb27-1" tabindex="-1"></a><span class="co"># Show the Relationship of methylation MHB and Gene expression in scRNA-levels</span></span>
<span id="cb27-2"><a href="figure-4.html#cb27-2" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb27-3"><a href="figure-4.html#cb27-3" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb27-4"><a href="figure-4.html#cb27-4" tabindex="-1"></a><span class="fu">library</span>(regioneR)</span>
<span id="cb27-5"><a href="figure-4.html#cb27-5" tabindex="-1"></a><span class="fu">library</span>(pbapply)</span>
<span id="cb27-6"><a href="figure-4.html#cb27-6" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb27-7"><a href="figure-4.html#cb27-7" tabindex="-1"></a><span class="co"># Step 1： promoter methylation</span></span>
<span id="cb27-8"><a href="figure-4.html#cb27-8" tabindex="-1"></a>scMethyl_Mcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/promoter_methylated.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span></span>
<span id="cb27-9"><a href="figure-4.html#cb27-9" tabindex="-1"></a>                    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb27-10"><a href="figure-4.html#cb27-10" tabindex="-1"></a>scMethyl_Tcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/promoter_total.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb27-11"><a href="figure-4.html#cb27-11" tabindex="-1"></a>                    <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb27-12"><a href="figure-4.html#cb27-12" tabindex="-1"></a><span class="co"># filter Promoter Total covered reads count &lt;3</span></span>
<span id="cb27-13"><a href="figure-4.html#cb27-13" tabindex="-1"></a>scMethyl_Tcounts[scMethyl_Tcounts<span class="sc">&lt;</span><span class="dv">3</span>]<span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb27-14"><a href="figure-4.html#cb27-14" tabindex="-1"></a>scMethyl <span class="ot">&lt;-</span> scMethyl_Mcounts<span class="sc">/</span>scMethyl_Tcounts </span>
<span id="cb27-15"><a href="figure-4.html#cb27-15" tabindex="-1"></a>scMethyl <span class="ot">&lt;-</span> scMethyl <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">separate</span>(region,<span class="at">into=</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),<span class="at">sep=</span><span class="st">&quot;[:-]&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-16"><a href="figure-4.html#cb27-16" tabindex="-1"></a>                         <span class="fu">mutate</span>(<span class="at">start=</span><span class="fu">as.numeric</span>(start)<span class="sc">-</span><span class="dv">1</span>,<span class="at">end=</span><span class="fu">as.numeric</span>(end))</span>
<span id="cb27-17"><a href="figure-4.html#cb27-17" tabindex="-1"></a><span class="co"># promoter anno</span></span>
<span id="cb27-18"><a href="figure-4.html#cb27-18" tabindex="-1"></a>Promoter <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;Data/Processed_data/GREATv4.genes.promoter_UD1000.hg19.bed&quot;</span>) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>,<span class="st">&quot;strand&quot;</span>,<span class="st">&quot;SYMBOL&quot;</span>))</span>
<span id="cb27-19"><a href="figure-4.html#cb27-19" tabindex="-1"></a>scMethyl <span class="ot">&lt;-</span> Promoter <span class="sc">%&gt;%</span> <span class="fu">inner_join</span>(scMethyl,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>))</span>
<span id="cb27-20"><a href="figure-4.html#cb27-20" tabindex="-1"></a><span class="co"># toGR</span></span>
<span id="cb27-21"><a href="figure-4.html#cb27-21" tabindex="-1"></a>scMethyl.GR <span class="ot">&lt;-</span> <span class="fu">makeGRangesFromDataFrame</span>(scMethyl,<span class="at">keep.extra=</span>T)</span>
<span id="cb27-22"><a href="figure-4.html#cb27-22" tabindex="-1"></a><span class="co"># sample id  with Paired RNA &amp; Methylation </span></span>
<span id="cb27-23"><a href="figure-4.html#cb27-23" tabindex="-1"></a>id <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Anno/GSE97693_scRNA_scMethyl_matched_info.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb27-24"><a href="figure-4.html#cb27-24" tabindex="-1"></a>      <span class="fu">select</span>(ID,patients,lesions,assay,tissue,tag) <span class="sc">%&gt;%</span> </span>
<span id="cb27-25"><a href="figure-4.html#cb27-25" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Methyl_ID =</span> <span class="fu">str_split_i</span>(ID,<span class="st">&quot;,&quot;</span>,<span class="at">i=</span><span class="dv">1</span>),<span class="at">Exp_ID=</span><span class="fu">str_split_i</span>(ID,<span class="st">&quot;,&quot;</span>,<span class="at">i=</span><span class="dv">2</span>))</span>
<span id="cb27-26"><a href="figure-4.html#cb27-26" tabindex="-1"></a><span class="co"># Promoters overlap with MHBs</span></span>
<span id="cb27-27"><a href="figure-4.html#cb27-27" tabindex="-1"></a>tag<span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;LN&quot;</span>,<span class="st">&quot;PT&quot;</span>,<span class="st">&quot;ML&quot;</span>,<span class="st">&quot;MP&quot;</span>,<span class="st">&quot;Tumor&quot;</span>)</span>
<span id="cb27-28"><a href="figure-4.html#cb27-28" tabindex="-1"></a>scMHB_Methyl <span class="ot">&lt;-</span> pbapply<span class="sc">::</span><span class="fu">pblapply</span>(tag,<span class="cf">function</span>(x){</span>
<span id="cb27-29"><a href="figure-4.html#cb27-29" tabindex="-1"></a>    path<span class="ot">=</span><span class="st">&quot;Data/Processed_data/MHB/singlecell/&quot;</span></span>
<span id="cb27-30"><a href="figure-4.html#cb27-30" tabindex="-1"></a>    MHB<span class="ot">&lt;-</span><span class="fu">toGRanges</span>(<span class="fu">paste0</span>(path,<span class="st">&quot;CRC_MHB_&quot;</span>,x,<span class="st">&quot;.bed&quot;</span>))</span>
<span id="cb27-31"><a href="figure-4.html#cb27-31" tabindex="-1"></a>    <span class="co"># overlapping</span></span>
<span id="cb27-32"><a href="figure-4.html#cb27-32" tabindex="-1"></a>    Tx <span class="ot">&lt;-</span> <span class="fu">findOverlaps</span>(scMethyl.GR,MHB,<span class="at">ignore.strand=</span>T)</span>
<span id="cb27-33"><a href="figure-4.html#cb27-33" tabindex="-1"></a>    a<span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">length</span>(scMethyl.GR))</span>
<span id="cb27-34"><a href="figure-4.html#cb27-34" tabindex="-1"></a>    <span class="co"># MHB </span></span>
<span id="cb27-35"><a href="figure-4.html#cb27-35" tabindex="-1"></a>    a[<span class="fu">unique</span>(<span class="fu">queryHits</span>(Tx))]<span class="ot">&lt;-</span><span class="st">&quot;T&quot;</span></span>
<span id="cb27-36"><a href="figure-4.html#cb27-36" tabindex="-1"></a>    a[<span class="fu">is.na</span>(a)]<span class="ot">&lt;-</span><span class="st">&quot;N&quot;</span></span>
<span id="cb27-37"><a href="figure-4.html#cb27-37" tabindex="-1"></a>    a<span class="ot">&lt;-</span> a <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb27-38"><a href="figure-4.html#cb27-38" tabindex="-1"></a>    <span class="fu">names</span>(a)<span class="ot">&lt;-</span><span class="st">&quot;MHB&quot;</span></span>
<span id="cb27-39"><a href="figure-4.html#cb27-39" tabindex="-1"></a>    <span class="co"># sample GSM ID</span></span>
<span id="cb27-40"><a href="figure-4.html#cb27-40" tabindex="-1"></a>    <span class="cf">if</span>(x<span class="sc">!=</span><span class="st">&quot;Tumor&quot;</span>){</span>
<span id="cb27-41"><a href="figure-4.html#cb27-41" tabindex="-1"></a>        sid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">str_detect</span>(tissue,x)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Methyl_ID)</span>
<span id="cb27-42"><a href="figure-4.html#cb27-42" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb27-43"><a href="figure-4.html#cb27-43" tabindex="-1"></a>        sid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Methyl_ID)</span>
<span id="cb27-44"><a href="figure-4.html#cb27-44" tabindex="-1"></a>    }  </span>
<span id="cb27-45"><a href="figure-4.html#cb27-45" tabindex="-1"></a>    <span class="co"># select</span></span>
<span id="cb27-46"><a href="figure-4.html#cb27-46" tabindex="-1"></a>    <span class="fu">mcols</span>(scMethyl.GR) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb27-47"><a href="figure-4.html#cb27-47" tabindex="-1"></a>                            <span class="fu">select</span>(SYMBOL,<span class="fu">all_of</span>(sid)) <span class="sc">%&gt;%</span></span>
<span id="cb27-48"><a href="figure-4.html#cb27-48" tabindex="-1"></a>                            <span class="fu">cbind</span>(a) <span class="sc">%&gt;%</span> <span class="fu">separate_rows</span>(SYMBOL,<span class="at">sep=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb27-49"><a href="figure-4.html#cb27-49" tabindex="-1"></a>  })</span>
<span id="cb27-50"><a href="figure-4.html#cb27-50" tabindex="-1"></a><span class="fu">names</span>(scMHB_Methyl) <span class="ot">&lt;-</span>tag</span>
<span id="cb27-51"><a href="figure-4.html#cb27-51" tabindex="-1"></a><span class="co"># Step 2: scRNA + Methylation</span></span>
<span id="cb27-52"><a href="figure-4.html#cb27-52" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;scMHB_GSE97693/Exp/GSE97693_scRNA_TPM_FPKM.RData&quot;</span>)</span>
<span id="cb27-53"><a href="figure-4.html#cb27-53" tabindex="-1"></a>scMme <span class="ot">&lt;-</span> pbapply<span class="sc">::</span><span class="fu">pblapply</span>(tag,<span class="cf">function</span>(x){</span>
<span id="cb27-54"><a href="figure-4.html#cb27-54" tabindex="-1"></a>    <span class="fu">cat</span>(x,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb27-55"><a href="figure-4.html#cb27-55" tabindex="-1"></a>    <span class="co"># methylation id</span></span>
<span id="cb27-56"><a href="figure-4.html#cb27-56" tabindex="-1"></a>    <span class="cf">if</span>(x<span class="sc">!=</span><span class="st">&quot;Tumor&quot;</span>){</span>
<span id="cb27-57"><a href="figure-4.html#cb27-57" tabindex="-1"></a>        mid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">str_detect</span>(tissue,x)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Methyl_ID) </span>
<span id="cb27-58"><a href="figure-4.html#cb27-58" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb27-59"><a href="figure-4.html#cb27-59" tabindex="-1"></a>        mid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Methyl_ID)</span>
<span id="cb27-60"><a href="figure-4.html#cb27-60" tabindex="-1"></a>    }  </span>
<span id="cb27-61"><a href="figure-4.html#cb27-61" tabindex="-1"></a>    <span class="co"># methylation data reshape</span></span>
<span id="cb27-62"><a href="figure-4.html#cb27-62" tabindex="-1"></a>    data_methyl <span class="ot">&lt;-</span> scMHB_Methyl[[x]] <span class="sc">%&gt;%</span> <span class="fu">melt</span>() <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> <span class="fu">nest</span>(<span class="at">.by=</span>variable) <span class="sc">%&gt;%</span> </span>
<span id="cb27-63"><a href="figure-4.html#cb27-63" tabindex="-1"></a>                                          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">MM =</span> <span class="fu">lapply</span>(data,<span class="cf">function</span>(y){</span>
<span id="cb27-64"><a href="figure-4.html#cb27-64" tabindex="-1"></a>                                                                 y <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">ifelse</span>(value<span class="sc">&gt;=</span><span class="fl">0.8</span>,<span class="st">&quot;high&quot;</span>,</span>
<span id="cb27-65"><a href="figure-4.html#cb27-65" tabindex="-1"></a>                                                                                   <span class="fu">ifelse</span>(value<span class="sc">&lt;=</span><span class="fl">0.2</span>,<span class="st">&quot;low&quot;</span>,<span class="st">&quot;intermediate&quot;</span>))) </span>
<span id="cb27-66"><a href="figure-4.html#cb27-66" tabindex="-1"></a>                                                              }))</span>
<span id="cb27-67"><a href="figure-4.html#cb27-67" tabindex="-1"></a>    <span class="co"># show the paired methylation &amp; expression ,one by one</span></span>
<span id="cb27-68"><a href="figure-4.html#cb27-68" tabindex="-1"></a>    SME <span class="ot">&lt;-</span> pbapply<span class="sc">::</span><span class="fu">pblapply</span>(mid,<span class="cf">function</span>(m) {</span>
<span id="cb27-69"><a href="figure-4.html#cb27-69" tabindex="-1"></a>              <span class="co">#mean vs median</span></span>
<span id="cb27-70"><a href="figure-4.html#cb27-70" tabindex="-1"></a>              <span class="cf">if</span>(<span class="dv">1</span>){</span>
<span id="cb27-71"><a href="figure-4.html#cb27-71" tabindex="-1"></a>                ExM <span class="ot">&lt;-</span> <span class="cf">function</span>(z) <span class="fu">mean</span>(z, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-72"><a href="figure-4.html#cb27-72" tabindex="-1"></a>              }<span class="cf">else</span>{</span>
<span id="cb27-73"><a href="figure-4.html#cb27-73" tabindex="-1"></a>                ExM <span class="ot">&lt;-</span> <span class="cf">function</span>(z) <span class="fu">median</span>(z, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-74"><a href="figure-4.html#cb27-74" tabindex="-1"></a>              }</span>
<span id="cb27-75"><a href="figure-4.html#cb27-75" tabindex="-1"></a>             <span class="fu">cat</span>(<span class="st">&quot;Processing&quot;</span>,m,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb27-76"><a href="figure-4.html#cb27-76" tabindex="-1"></a>              <span class="co"># Methylation</span></span>
<span id="cb27-77"><a href="figure-4.html#cb27-77" tabindex="-1"></a>             data <span class="ot">&lt;-</span>  data_methyl  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(variable<span class="sc">==</span>m) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(MM) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb27-78"><a href="figure-4.html#cb27-78" tabindex="-1"></a>                                                              <span class="fu">group_by</span>(MHB,type) <span class="sc">%&gt;%</span> </span>
<span id="cb27-79"><a href="figure-4.html#cb27-79" tabindex="-1"></a>                                                              <span class="fu">transmute</span>(<span class="at">genes=</span><span class="fu">paste0</span>(SYMBOL, <span class="at">collapse=</span><span class="st">&quot;,&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>()</span>
<span id="cb27-80"><a href="figure-4.html#cb27-80" tabindex="-1"></a>              <span class="co"># Exp</span></span>
<span id="cb27-81"><a href="figure-4.html#cb27-81" tabindex="-1"></a>              <span class="co"># test the RNA data </span></span>
<span id="cb27-82"><a href="figure-4.html#cb27-82" tabindex="-1"></a>              <span class="co"># paired Exp id</span></span>
<span id="cb27-83"><a href="figure-4.html#cb27-83" tabindex="-1"></a>                eid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">str_detect</span>(Methyl_ID,m)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Exp_ID) </span>
<span id="cb27-84"><a href="figure-4.html#cb27-84" tabindex="-1"></a>                <span class="cf">if</span>(<span class="fu">sum</span>(<span class="fu">str_detect</span>(<span class="fu">names</span>(RNA.TPM),eid))<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb27-85"><a href="figure-4.html#cb27-85" tabindex="-1"></a>                    RNA <span class="ot">&lt;-</span> RNA.TPM</span>
<span id="cb27-86"><a href="figure-4.html#cb27-86" tabindex="-1"></a>                    <span class="fu">cat</span>(<span class="st">&quot;RNA_TPM &quot;</span>,x, <span class="st">&quot; &quot;</span>,m, <span class="st">&quot; &quot;</span>, eid,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb27-87"><a href="figure-4.html#cb27-87" tabindex="-1"></a>                    flag<span class="ot">&lt;-</span><span class="st">&quot;TPM&quot;</span></span>
<span id="cb27-88"><a href="figure-4.html#cb27-88" tabindex="-1"></a>                }<span class="cf">else</span>{</span>
<span id="cb27-89"><a href="figure-4.html#cb27-89" tabindex="-1"></a>                    RNA <span class="ot">&lt;-</span> RNA.FPKM</span>
<span id="cb27-90"><a href="figure-4.html#cb27-90" tabindex="-1"></a>                    <span class="fu">cat</span>(<span class="st">&quot;RNA_FPKM &quot;</span>,x, <span class="st">&quot; &quot;</span>,m, <span class="st">&quot; &quot;</span>, eid,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb27-91"><a href="figure-4.html#cb27-91" tabindex="-1"></a>                    flag <span class="ot">&lt;-</span><span class="st">&quot;FPKM&quot;</span></span>
<span id="cb27-92"><a href="figure-4.html#cb27-92" tabindex="-1"></a>                }</span>
<span id="cb27-93"><a href="figure-4.html#cb27-93" tabindex="-1"></a>                            <span class="co"># 6 groups</span></span>
<span id="cb27-94"><a href="figure-4.html#cb27-94" tabindex="-1"></a>                            <span class="co"># 1.high_mhb</span></span>
<span id="cb27-95"><a href="figure-4.html#cb27-95" tabindex="-1"></a>                                  Hm<span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(MHB<span class="sc">==</span><span class="st">&quot;T&quot;</span> <span class="sc">&amp;</span> type<span class="sc">==</span><span class="st">&quot;high&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(genes) <span class="sc">%&gt;%</span> <span class="fu">str_split_1</span>(<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb27-96"><a href="figure-4.html#cb27-96" tabindex="-1"></a>                                  HmE<span class="ot">&lt;-</span> RNA <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">contains</span>(eid)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">rownames</span>(.) <span class="sc">%in%</span> Hm) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">1</span>)</span>
<span id="cb27-97"><a href="figure-4.html#cb27-97" tabindex="-1"></a>                                  HmE <span class="ot">&lt;-</span> <span class="fu">log2</span>(<span class="fu">ExM</span>(HmE) <span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb27-98"><a href="figure-4.html#cb27-98" tabindex="-1"></a>                            <span class="co"># 2.high_nonmhb</span></span>
<span id="cb27-99"><a href="figure-4.html#cb27-99" tabindex="-1"></a>                                  Hnm<span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(MHB<span class="sc">==</span><span class="st">&quot;N&quot;</span> <span class="sc">&amp;</span> type<span class="sc">==</span><span class="st">&quot;high&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(genes) <span class="sc">%&gt;%</span> <span class="fu">str_split_1</span>(<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb27-100"><a href="figure-4.html#cb27-100" tabindex="-1"></a>                                  HnmE<span class="ot">&lt;-</span>RNA <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">contains</span>(eid)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">rownames</span>(.) <span class="sc">%in%</span> Hnm) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">1</span>)</span>
<span id="cb27-101"><a href="figure-4.html#cb27-101" tabindex="-1"></a>                                  HnmE <span class="ot">&lt;-</span> <span class="fu">log2</span>(<span class="fu">ExM</span>(HnmE) <span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb27-102"><a href="figure-4.html#cb27-102" tabindex="-1"></a>                            <span class="co"># 3.intermediate_mhb</span></span>
<span id="cb27-103"><a href="figure-4.html#cb27-103" tabindex="-1"></a>                                  Im<span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(MHB<span class="sc">==</span><span class="st">&quot;T&quot;</span> <span class="sc">&amp;</span> type<span class="sc">==</span><span class="st">&quot;intermediate&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(genes) <span class="sc">%&gt;%</span> <span class="fu">str_split_1</span>(<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb27-104"><a href="figure-4.html#cb27-104" tabindex="-1"></a>                                  ImE<span class="ot">&lt;-</span>RNA <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">contains</span>(eid)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">rownames</span>(.) <span class="sc">%in%</span> Im) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">1</span>)</span>
<span id="cb27-105"><a href="figure-4.html#cb27-105" tabindex="-1"></a>                                  ImE <span class="ot">&lt;-</span> <span class="fu">log2</span>(<span class="fu">ExM</span>(ImE) <span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb27-106"><a href="figure-4.html#cb27-106" tabindex="-1"></a>                            <span class="co"># 4.intermediate_nonmhb</span></span>
<span id="cb27-107"><a href="figure-4.html#cb27-107" tabindex="-1"></a>                                  Inm<span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(MHB<span class="sc">==</span><span class="st">&quot;N&quot;</span> <span class="sc">&amp;</span> type<span class="sc">==</span><span class="st">&quot;intermediate&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(genes) <span class="sc">%&gt;%</span> <span class="fu">str_split_1</span>(<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb27-108"><a href="figure-4.html#cb27-108" tabindex="-1"></a>                                  InmE<span class="ot">&lt;-</span>RNA <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">contains</span>(eid)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">rownames</span>(.) <span class="sc">%in%</span> Inm) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">1</span>)</span>
<span id="cb27-109"><a href="figure-4.html#cb27-109" tabindex="-1"></a>                                  InmE <span class="ot">&lt;-</span> <span class="fu">log2</span>(<span class="fu">ExM</span>(InmE) <span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb27-110"><a href="figure-4.html#cb27-110" tabindex="-1"></a>                            <span class="co"># 5.low_mhb</span></span>
<span id="cb27-111"><a href="figure-4.html#cb27-111" tabindex="-1"></a>                                  Lm<span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(MHB<span class="sc">==</span><span class="st">&quot;T&quot;</span> <span class="sc">&amp;</span> type<span class="sc">==</span><span class="st">&quot;low&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(genes) <span class="sc">%&gt;%</span> <span class="fu">str_split_1</span>(<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb27-112"><a href="figure-4.html#cb27-112" tabindex="-1"></a>                                  LmE<span class="ot">&lt;-</span>RNA <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">contains</span>(eid)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">rownames</span>(.) <span class="sc">%in%</span> Lm) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">1</span>)</span>
<span id="cb27-113"><a href="figure-4.html#cb27-113" tabindex="-1"></a>                                  LmE <span class="ot">&lt;-</span> <span class="fu">log2</span>(<span class="fu">ExM</span>(LmE) <span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb27-114"><a href="figure-4.html#cb27-114" tabindex="-1"></a>                            <span class="co"># 6.low_nonmhb</span></span>
<span id="cb27-115"><a href="figure-4.html#cb27-115" tabindex="-1"></a>                                  Lnm<span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(MHB<span class="sc">==</span><span class="st">&quot;N&quot;</span> <span class="sc">&amp;</span> type<span class="sc">==</span><span class="st">&quot;low&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(genes) <span class="sc">%&gt;%</span> <span class="fu">str_split_1</span>(<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb27-116"><a href="figure-4.html#cb27-116" tabindex="-1"></a>                                  LnmE<span class="ot">&lt;-</span>RNA <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">contains</span>(eid)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">rownames</span>(.) <span class="sc">%in%</span> Lnm) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">1</span>)</span>
<span id="cb27-117"><a href="figure-4.html#cb27-117" tabindex="-1"></a>                                  LnmE <span class="ot">&lt;-</span> <span class="fu">log2</span>(<span class="fu">ExM</span>(LnmE) <span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb27-118"><a href="figure-4.html#cb27-118" tabindex="-1"></a>                            </span>
<span id="cb27-119"><a href="figure-4.html#cb27-119" tabindex="-1"></a>                            <span class="co"># the Exp of methylation level in one cell</span></span>
<span id="cb27-120"><a href="figure-4.html#cb27-120" tabindex="-1"></a>                            <span class="fu">c</span>(HmE,HnmE,ImE,InmE,LmE,LnmE,flag)</span>
<span id="cb27-121"><a href="figure-4.html#cb27-121" tabindex="-1"></a>    })</span>
<span id="cb27-122"><a href="figure-4.html#cb27-122" tabindex="-1"></a>              <span class="fu">names</span>(SME) <span class="ot">&lt;-</span> mid</span>
<span id="cb27-123"><a href="figure-4.html#cb27-123" tabindex="-1"></a>              <span class="co"># cancer type : promoter methyltion + MHB +  Expression </span></span>
<span id="cb27-124"><a href="figure-4.html#cb27-124" tabindex="-1"></a>              CME <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind,SME) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-125"><a href="figure-4.html#cb27-125" tabindex="-1"></a>                    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;HmE&quot;</span>,<span class="st">&quot;HnmE&quot;</span>,<span class="st">&quot;ImE&quot;</span>,<span class="st">&quot;InmE&quot;</span>,<span class="st">&quot;LmE&quot;</span>,<span class="st">&quot;LnmE&quot;</span>,<span class="st">&quot;Ex&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-126"><a href="figure-4.html#cb27-126" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">ID=</span><span class="fu">rownames</span>(.))</span>
<span id="cb27-127"><a href="figure-4.html#cb27-127" tabindex="-1"></a>  })</span>
<span id="cb27-128"><a href="figure-4.html#cb27-128" tabindex="-1"></a><span class="fu">names</span>(scMme) <span class="ot">&lt;-</span> tag </span>
<span id="cb27-129"><a href="figure-4.html#cb27-129" tabindex="-1"></a><span class="co"># sc_MMET: Methylation + MHB + Exp</span></span>
<span id="cb27-130"><a href="figure-4.html#cb27-130" tabindex="-1"></a>GSE97693_scMMET <span class="ot">&lt;-</span> scMme</span>
<span id="cb27-131"><a href="figure-4.html#cb27-131" tabindex="-1"></a></span>
<span id="cb27-132"><a href="figure-4.html#cb27-132" tabindex="-1"></a><span class="co"># Step 3: PLOT</span></span>
<span id="cb27-133"><a href="figure-4.html#cb27-133" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb27-134"><a href="figure-4.html#cb27-134" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb27-135"><a href="figure-4.html#cb27-135" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb27-136"><a href="figure-4.html#cb27-136" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb27-137"><a href="figure-4.html#cb27-137" tabindex="-1"></a></span>
<span id="cb27-138"><a href="figure-4.html#cb27-138" tabindex="-1"></a>n<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb27-139"><a href="figure-4.html#cb27-139" tabindex="-1"></a><span class="cf">for</span> ( x <span class="cf">in</span> tag ){</span>
<span id="cb27-140"><a href="figure-4.html#cb27-140" tabindex="-1"></a></span>
<span id="cb27-141"><a href="figure-4.html#cb27-141" tabindex="-1"></a>    <span class="fu">cat</span>(x,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb27-142"><a href="figure-4.html#cb27-142" tabindex="-1"></a>    n <span class="ot">=</span> n <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb27-143"><a href="figure-4.html#cb27-143" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(GSE97693_scMMET[[x]])){   <span class="do">###check is null</span></span>
<span id="cb27-144"><a href="figure-4.html#cb27-144" tabindex="-1"></a></span>
<span id="cb27-145"><a href="figure-4.html#cb27-145" tabindex="-1"></a>        data <span class="ot">&lt;-</span> GSE97693_scMMET[[x]] <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb27-146"><a href="figure-4.html#cb27-146" tabindex="-1"></a>                <span class="fu">gather</span>(<span class="st">&quot;Type&quot;</span>,<span class="st">&quot;Exp&quot;</span>,<span class="sc">-</span><span class="fu">c</span>(ID,Ex)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Me=</span><span class="fu">str_sub</span>(Type,<span class="dv">0</span>,<span class="dv">1</span>),<span class="at">MHB=</span><span class="fu">toupper</span>(<span class="fu">str_sub</span>(Type,<span class="dv">2</span>,<span class="dv">2</span>)),</span>
<span id="cb27-147"><a href="figure-4.html#cb27-147" tabindex="-1"></a>                                                          <span class="at">Exp=</span><span class="fu">as.numeric</span>(Exp),<span class="at">Ex=</span><span class="fu">fct_inorder</span>(Ex))</span>
<span id="cb27-148"><a href="figure-4.html#cb27-148" tabindex="-1"></a>        </span>
<span id="cb27-149"><a href="figure-4.html#cb27-149" tabindex="-1"></a>        <span class="do">## plot</span></span>
<span id="cb27-150"><a href="figure-4.html#cb27-150" tabindex="-1"></a>        <span class="fu">compare_means</span>(Exp <span class="sc">~</span> MHB, <span class="at">data =</span> data, <span class="at">group.by =</span> <span class="fu">c</span>(<span class="st">&quot;Me&quot;</span>,<span class="st">&quot;Ex&quot;</span>))</span>
<span id="cb27-151"><a href="figure-4.html#cb27-151" tabindex="-1"></a>        <span class="fu">assign</span>(<span class="fu">paste0</span>(<span class="st">&quot;p&quot;</span>,n),<span class="fu">ggboxplot</span>(data, <span class="at">x =</span> <span class="st">&quot;Me&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Exp&quot;</span>, <span class="at">color =</span> <span class="st">&quot;MHB&quot;</span>,</span>
<span id="cb27-152"><a href="figure-4.html#cb27-152" tabindex="-1"></a>                        <span class="at">palette =</span><span class="st">&quot;nejm&quot;</span>,<span class="at">width=</span><span class="fl">0.8</span>,</span>
<span id="cb27-153"><a href="figure-4.html#cb27-153" tabindex="-1"></a>                        <span class="at">bxp.errorbar =</span> T,</span>
<span id="cb27-154"><a href="figure-4.html#cb27-154" tabindex="-1"></a>                        <span class="at">add =</span> <span class="st">&quot;jitter&quot;</span>,</span>
<span id="cb27-155"><a href="figure-4.html#cb27-155" tabindex="-1"></a>                        <span class="at">add.params =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="fl">0.05</span>),</span>
<span id="cb27-156"><a href="figure-4.html#cb27-156" tabindex="-1"></a>                        <span class="at">facet.by =</span> <span class="st">&quot;Ex&quot;</span>, <span class="at">short.panel.labs =</span> <span class="cn">FALSE</span></span>
<span id="cb27-157"><a href="figure-4.html#cb27-157" tabindex="-1"></a>                        ) <span class="sc">+</span></span>
<span id="cb27-158"><a href="figure-4.html#cb27-158" tabindex="-1"></a>                        <span class="fu">xlab</span>(<span class="st">&quot;Methylation-level&quot;</span>)<span class="sc">+</span> </span>
<span id="cb27-159"><a href="figure-4.html#cb27-159" tabindex="-1"></a>                        <span class="fu">ylab</span>(<span class="st">&quot;Expression&quot;</span>)<span class="sc">+</span></span>
<span id="cb27-160"><a href="figure-4.html#cb27-160" tabindex="-1"></a>                        <span class="fu">ggtitle</span>(<span class="fu">ifelse</span>(x<span class="sc">==</span><span class="st">&quot;MHB_T&quot;</span>,<span class="st">&quot;Tumor&quot;</span>,x))<span class="sc">+</span> </span>
<span id="cb27-161"><a href="figure-4.html#cb27-161" tabindex="-1"></a>                        <span class="fu">stat_compare_means</span>(<span class="fu">aes</span>(<span class="at">group =</span> MHB),<span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb27-162"><a href="figure-4.html#cb27-162" tabindex="-1"></a>                        <span class="fu">theme_bw</span>() <span class="sc">+</span>    </span>
<span id="cb27-163"><a href="figure-4.html#cb27-163" tabindex="-1"></a>                        <span class="fu">theme</span>(<span class="at">panel.grid.major=</span><span class="fu">element_line</span>(<span class="at">colour=</span><span class="cn">NA</span>),</span>
<span id="cb27-164"><a href="figure-4.html#cb27-164" tabindex="-1"></a>                        <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>,<span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb27-165"><a href="figure-4.html#cb27-165" tabindex="-1"></a>                        <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>,<span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb27-166"><a href="figure-4.html#cb27-166" tabindex="-1"></a>                        <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb27-167"><a href="figure-4.html#cb27-167" tabindex="-1"></a>                        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>,<span class="at">vjust =</span> <span class="dv">1</span>,<span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb27-168"><a href="figure-4.html#cb27-168" tabindex="-1"></a>                        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb27-169"><a href="figure-4.html#cb27-169" tabindex="-1"></a>                        <span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="cn">NA</span>,<span class="at">color=</span><span class="st">&quot;black&quot;</span>, <span class="at">size=</span><span class="dv">1</span>, <span class="at">linetype=</span><span class="st">&quot;solid&quot;</span>))</span>
<span id="cb27-170"><a href="figure-4.html#cb27-170" tabindex="-1"></a>             )</span>
<span id="cb27-171"><a href="figure-4.html#cb27-171" tabindex="-1"></a>             <span class="fu">cat</span>(n,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb27-172"><a href="figure-4.html#cb27-172" tabindex="-1"></a>    }</span>
<span id="cb27-173"><a href="figure-4.html#cb27-173" tabindex="-1"></a>}</span>
<span id="cb27-174"><a href="figure-4.html#cb27-174" tabindex="-1"></a><span class="co"># paste to one figure </span></span>
<span id="cb27-175"><a href="figure-4.html#cb27-175" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p1, p2, p3, p4,p5)</span>
<span id="cb27-176"><a href="figure-4.html#cb27-176" tabindex="-1"></a><span class="fu">ggsave</span>(p,<span class="at">filename=</span><span class="fu">paste0</span>(<span class="st">&quot;Data/Figures/Fig4/Fig4.E.pdf&quot;</span>),<span class="at">width=</span><span class="dv">16</span>,<span class="at">height=</span><span class="dv">6</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-51"></span>
<img src="Data/Figures/Fig4/Fig4.E.png" alt="Fig4.E" width="90%" id="fig-unnamed-chunk-51-1" />
<p class="caption">
 4.4: Fig4.E
</p>
</div>
</div>
<div id="f.-association-of-gene-expression-and-methylation-levels-of-mhb-regions" class="section level2 hasAnchor" number="4.5">
<h2><span class="header-section-number">4.5</span> (F). Association of gene expression and methylation levels of MHB regions<a href="figure-4.html#f.-association-of-gene-expression-and-methylation-levels-of-mhb-regions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="figure-4.html#cb28-1" tabindex="-1"></a><span class="co"># Show the relationship of between methylation MHB level and  Gene expression in scRNA-levels</span></span>
<span id="cb28-2"><a href="figure-4.html#cb28-2" tabindex="-1"></a><span class="co"># Step1: promoter methylation</span></span>
<span id="cb28-3"><a href="figure-4.html#cb28-3" tabindex="-1"></a>scMethyl_Mcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/promoter_methylated.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="figure-4.html#cb28-4" tabindex="-1"></a>                    <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb28-5"><a href="figure-4.html#cb28-5" tabindex="-1"></a>scMethyl_Tcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/promoter_total.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-6"><a href="figure-4.html#cb28-6" tabindex="-1"></a>                    <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb28-7"><a href="figure-4.html#cb28-7" tabindex="-1"></a><span class="co"># filter promoter total reads count &lt;3 </span></span>
<span id="cb28-8"><a href="figure-4.html#cb28-8" tabindex="-1"></a>scMethyl_Tcounts[scMethyl_Tcounts<span class="sc">&lt;</span><span class="dv">3</span>]<span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb28-9"><a href="figure-4.html#cb28-9" tabindex="-1"></a>scMethyl <span class="ot">&lt;-</span> scMethyl_Mcounts<span class="sc">/</span>scMethyl_Tcounts </span>
<span id="cb28-10"><a href="figure-4.html#cb28-10" tabindex="-1"></a>scMethyl <span class="ot">&lt;-</span> scMethyl <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">separate</span>(region,<span class="at">into=</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),<span class="at">sep=</span><span class="st">&quot;[:-]&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-11"><a href="figure-4.html#cb28-11" tabindex="-1"></a>                         <span class="fu">mutate</span>(<span class="at">start=</span><span class="fu">as.numeric</span>(start)<span class="sc">-</span><span class="dv">1</span>,<span class="at">end=</span><span class="fu">as.numeric</span>(end))</span>
<span id="cb28-12"><a href="figure-4.html#cb28-12" tabindex="-1"></a><span class="co"># promoter anno</span></span>
<span id="cb28-13"><a href="figure-4.html#cb28-13" tabindex="-1"></a>Promoter <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;Data/Processed_data/GREATv4.genes.promoter_UD1000.hg19.bed&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-14"><a href="figure-4.html#cb28-14" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>,<span class="st">&quot;strand&quot;</span>,<span class="st">&quot;SYMBOL&quot;</span>))</span>
<span id="cb28-15"><a href="figure-4.html#cb28-15" tabindex="-1"></a>scMethyl <span class="ot">&lt;-</span> Promoter <span class="sc">%&gt;%</span> <span class="fu">inner_join</span>(scMethyl,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>))</span>
<span id="cb28-16"><a href="figure-4.html#cb28-16" tabindex="-1"></a><span class="co"># toGR</span></span>
<span id="cb28-17"><a href="figure-4.html#cb28-17" tabindex="-1"></a>scMethyl.GR <span class="ot">&lt;-</span> <span class="fu">makeGRangesFromDataFrame</span>(scMethyl,<span class="at">keep.extra=</span>T)</span>
<span id="cb28-18"><a href="figure-4.html#cb28-18" tabindex="-1"></a><span class="co"># sample id  with Paired RNA &amp; Methylation </span></span>
<span id="cb28-19"><a href="figure-4.html#cb28-19" tabindex="-1"></a>id <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Anno/GSE97693_scRNA_scMethyl_matched_info.txt&quot;</span>,<span class="at">header=</span>F) <span class="sc">%&gt;%</span> </span>
<span id="cb28-20"><a href="figure-4.html#cb28-20" tabindex="-1"></a>      <span class="fu">select</span>(ID,patients,lesions,assay,tissue,tag) <span class="sc">%&gt;%</span> </span>
<span id="cb28-21"><a href="figure-4.html#cb28-21" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Methyl_ID =</span> <span class="fu">str_split_i</span>(ID,<span class="st">&quot;,&quot;</span>,<span class="at">i=</span><span class="dv">1</span>),<span class="at">Exp_ID=</span><span class="fu">str_split_i</span>(ID,<span class="st">&quot;,&quot;</span>,<span class="at">i=</span><span class="dv">2</span>))</span>
<span id="cb28-22"><a href="figure-4.html#cb28-22" tabindex="-1"></a><span class="co"># promoter overlaps with MHB</span></span>
<span id="cb28-23"><a href="figure-4.html#cb28-23" tabindex="-1"></a>tag<span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;LN&quot;</span>,<span class="st">&quot;PT&quot;</span>,<span class="st">&quot;ML&quot;</span>,<span class="st">&quot;MP&quot;</span>,<span class="st">&quot;Tumor&quot;</span>)</span>
<span id="cb28-24"><a href="figure-4.html#cb28-24" tabindex="-1"></a>scMHB_Methyl <span class="ot">&lt;-</span> pbapply<span class="sc">::</span><span class="fu">pblapply</span>(tag,<span class="cf">function</span>(x){</span>
<span id="cb28-25"><a href="figure-4.html#cb28-25" tabindex="-1"></a>    path<span class="ot">=</span><span class="st">&quot;Data/Processed_data/MHB/singlecell/&quot;</span></span>
<span id="cb28-26"><a href="figure-4.html#cb28-26" tabindex="-1"></a>    MHB<span class="ot">&lt;-</span><span class="fu">toGRanges</span>(<span class="fu">paste0</span>(path,<span class="st">&quot;CRC_MHB_&quot;</span>,x,<span class="st">&quot;.bed&quot;</span>))</span>
<span id="cb28-27"><a href="figure-4.html#cb28-27" tabindex="-1"></a>    <span class="co"># overlapping </span></span>
<span id="cb28-28"><a href="figure-4.html#cb28-28" tabindex="-1"></a>    Tx <span class="ot">&lt;-</span> <span class="fu">findOverlaps</span>(scMethyl.GR,MHB,<span class="at">ignore.strand=</span>T)</span>
<span id="cb28-29"><a href="figure-4.html#cb28-29" tabindex="-1"></a>    a<span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">length</span>(scMethyl.GR))</span>
<span id="cb28-30"><a href="figure-4.html#cb28-30" tabindex="-1"></a>    <span class="co"># MHB </span></span>
<span id="cb28-31"><a href="figure-4.html#cb28-31" tabindex="-1"></a>    a[<span class="fu">unique</span>(<span class="fu">queryHits</span>(Tx))]<span class="ot">&lt;-</span><span class="st">&quot;T&quot;</span></span>
<span id="cb28-32"><a href="figure-4.html#cb28-32" tabindex="-1"></a>    a[<span class="fu">is.na</span>(a)]<span class="ot">&lt;-</span><span class="st">&quot;N&quot;</span></span>
<span id="cb28-33"><a href="figure-4.html#cb28-33" tabindex="-1"></a>    a<span class="ot">&lt;-</span> a <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb28-34"><a href="figure-4.html#cb28-34" tabindex="-1"></a>    <span class="fu">names</span>(a)<span class="ot">&lt;-</span><span class="st">&quot;MHB&quot;</span></span>
<span id="cb28-35"><a href="figure-4.html#cb28-35" tabindex="-1"></a>    <span class="co"># sample GSM ID</span></span>
<span id="cb28-36"><a href="figure-4.html#cb28-36" tabindex="-1"></a>    <span class="cf">if</span>(x<span class="sc">!=</span><span class="st">&quot;Tumor&quot;</span>){</span>
<span id="cb28-37"><a href="figure-4.html#cb28-37" tabindex="-1"></a>        sid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">str_detect</span>(tissue,x)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Methyl_ID)</span>
<span id="cb28-38"><a href="figure-4.html#cb28-38" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb28-39"><a href="figure-4.html#cb28-39" tabindex="-1"></a>        sid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Methyl_ID)</span>
<span id="cb28-40"><a href="figure-4.html#cb28-40" tabindex="-1"></a>    }  </span>
<span id="cb28-41"><a href="figure-4.html#cb28-41" tabindex="-1"></a>    <span class="co"># select</span></span>
<span id="cb28-42"><a href="figure-4.html#cb28-42" tabindex="-1"></a>    <span class="fu">mcols</span>(scMethyl.GR) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-43"><a href="figure-4.html#cb28-43" tabindex="-1"></a>                            <span class="fu">select</span>(SYMBOL,<span class="fu">all_of</span>(sid)) <span class="sc">%&gt;%</span></span>
<span id="cb28-44"><a href="figure-4.html#cb28-44" tabindex="-1"></a>                            <span class="fu">cbind</span>(a) </span>
<span id="cb28-45"><a href="figure-4.html#cb28-45" tabindex="-1"></a>})</span>
<span id="cb28-46"><a href="figure-4.html#cb28-46" tabindex="-1"></a><span class="fu">names</span>(scMHB_Methyl) <span class="ot">&lt;-</span>tag</span>
<span id="cb28-47"><a href="figure-4.html#cb28-47" tabindex="-1"></a><span class="co"># Step 2: scRNA + Methylation</span></span>
<span id="cb28-48"><a href="figure-4.html#cb28-48" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;scMHB_GSE97693/Exp/GSE97693_scRNA_TPM_FPKM.RData&quot;</span>)</span>
<span id="cb28-49"><a href="figure-4.html#cb28-49" tabindex="-1"></a></span>
<span id="cb28-50"><a href="figure-4.html#cb28-50" tabindex="-1"></a>scMme <span class="ot">&lt;-</span> pbapply<span class="sc">::</span><span class="fu">pblapply</span>(tag,<span class="cf">function</span>(x){</span>
<span id="cb28-51"><a href="figure-4.html#cb28-51" tabindex="-1"></a>    <span class="fu">cat</span>(x,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-52"><a href="figure-4.html#cb28-52" tabindex="-1"></a>    <span class="co"># methylation id</span></span>
<span id="cb28-53"><a href="figure-4.html#cb28-53" tabindex="-1"></a>    <span class="cf">if</span>(x<span class="sc">!=</span><span class="st">&quot;Tumor&quot;</span>){</span>
<span id="cb28-54"><a href="figure-4.html#cb28-54" tabindex="-1"></a>        mid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">str_detect</span>(tissue,x)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Methyl_ID) </span>
<span id="cb28-55"><a href="figure-4.html#cb28-55" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb28-56"><a href="figure-4.html#cb28-56" tabindex="-1"></a>        mid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Methyl_ID)</span>
<span id="cb28-57"><a href="figure-4.html#cb28-57" tabindex="-1"></a>    }  </span>
<span id="cb28-58"><a href="figure-4.html#cb28-58" tabindex="-1"></a>    <span class="co"># methylation data reshape</span></span>
<span id="cb28-59"><a href="figure-4.html#cb28-59" tabindex="-1"></a>    data_methyl <span class="ot">&lt;-</span> scMHB_Methyl[[x]] <span class="sc">%&gt;%</span> <span class="fu">melt</span>() <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> <span class="fu">nest</span>(<span class="at">.by=</span>variable) <span class="sc">%&gt;%</span> </span>
<span id="cb28-60"><a href="figure-4.html#cb28-60" tabindex="-1"></a>                                          dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">MM =</span> <span class="fu">lapply</span>(data,<span class="cf">function</span>(y){</span>
<span id="cb28-61"><a href="figure-4.html#cb28-61" tabindex="-1"></a>                                                                 y <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">ifelse</span>(value<span class="sc">&gt;=</span><span class="fl">0.8</span>,<span class="st">&quot;high&quot;</span>,</span>
<span id="cb28-62"><a href="figure-4.html#cb28-62" tabindex="-1"></a>                                                                                   <span class="fu">ifelse</span>(value<span class="sc">&lt;=</span><span class="fl">0.2</span>,<span class="st">&quot;low&quot;</span>,<span class="st">&quot;Intermediate&quot;</span>)))</span>
<span id="cb28-63"><a href="figure-4.html#cb28-63" tabindex="-1"></a>                                                              }))</span>
<span id="cb28-64"><a href="figure-4.html#cb28-64" tabindex="-1"></a><span class="co"># MHB Methylation</span></span>
<span id="cb28-65"><a href="figure-4.html#cb28-65" tabindex="-1"></a>scMethyl_MHB_Mcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">paste0</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/CRC_MHB_&quot;</span>,x,<span class="st">&quot;_methylated.txt&quot;</span>),<span class="at">header=</span>T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-66"><a href="figure-4.html#cb28-66" tabindex="-1"></a>                        <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb28-67"><a href="figure-4.html#cb28-67" tabindex="-1"></a>scMethyl_MHB_Tcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">paste0</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/CRC_MHB_&quot;</span>,x,<span class="st">&quot;_total.txt&quot;</span>),<span class="at">header=</span>T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-68"><a href="figure-4.html#cb28-68" tabindex="-1"></a>                        <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb28-69"><a href="figure-4.html#cb28-69" tabindex="-1"></a><span class="co"># filter MHB with Total reads count &lt;3</span></span>
<span id="cb28-70"><a href="figure-4.html#cb28-70" tabindex="-1"></a>scMethyl_MHB_Tcounts[scMethyl_MHB_Tcounts<span class="sc">&lt;</span><span class="dv">3</span>]<span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb28-71"><a href="figure-4.html#cb28-71" tabindex="-1"></a>scMethyl_MHB <span class="ot">&lt;-</span> scMethyl_MHB_Mcounts<span class="sc">/</span>scMethyl_MHB_Tcounts </span>
<span id="cb28-72"><a href="figure-4.html#cb28-72" tabindex="-1"></a>scMethyl_MHB.GR <span class="ot">&lt;-</span> scMethyl_MHB  <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">separate</span>(region,<span class="at">into=</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),<span class="at">sep=</span><span class="st">&quot;[:-]&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-73"><a href="figure-4.html#cb28-73" tabindex="-1"></a>                         <span class="fu">mutate</span>(<span class="at">start=</span><span class="fu">as.numeric</span>(start)<span class="sc">-</span><span class="dv">1</span>,<span class="at">end=</span><span class="fu">as.numeric</span>(end)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-74"><a href="figure-4.html#cb28-74" tabindex="-1"></a>                         <span class="fu">toGRanges</span>() <span class="sc">%&gt;%</span> <span class="fu">great</span>(<span class="at">cores=</span><span class="dv">10</span>,<span class="st">&quot;MSigDB:H&quot;</span>, <span class="st">&quot;GREAT:hg19&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-75"><a href="figure-4.html#cb28-75" tabindex="-1"></a>                         <span class="fu">getRegionGeneAssociations</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-76"><a href="figure-4.html#cb28-76" tabindex="-1"></a>                         <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span>  <span class="fu">mutate</span>(<span class="at">annotated_genes=</span><span class="fu">lapply</span>(annotated_genes,<span class="cf">function</span>(x){</span>
<span id="cb28-77"><a href="figure-4.html#cb28-77" tabindex="-1"></a>                         x <span class="sc">%&gt;%</span> <span class="fu">paste</span>(<span class="at">collapse=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb28-78"><a href="figure-4.html#cb28-78" tabindex="-1"></a>                         }) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind,.) <span class="sc">%&gt;%</span> <span class="fu">as.character</span>(),</span>
<span id="cb28-79"><a href="figure-4.html#cb28-79" tabindex="-1"></a>                        <span class="at">dist_to_TSS =</span> <span class="fu">lapply</span>(dist_to_TSS,<span class="cf">function</span>(x){</span>
<span id="cb28-80"><a href="figure-4.html#cb28-80" tabindex="-1"></a>                                            x <span class="sc">%&gt;%</span> <span class="fu">paste</span>(<span class="at">collapse=</span><span class="st">&quot;,&quot;</span>)</span>
<span id="cb28-81"><a href="figure-4.html#cb28-81" tabindex="-1"></a>                        }) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind,.) <span class="sc">%&gt;%</span> <span class="fu">as.character</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb28-82"><a href="figure-4.html#cb28-82" tabindex="-1"></a>                        <span class="fu">separate_rows</span>(annotated_genes,dist_to_TSS,<span class="at">sep=</span><span class="st">&quot;,&quot;</span>,<span class="at">convert=</span><span class="cn">TRUE</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb28-83"><a href="figure-4.html#cb28-83" tabindex="-1"></a>                        <span class="fu">filter</span>(<span class="fu">abs</span>(dist_to_TSS)<span class="sc">&lt;</span> <span class="dv">1000</span>)  <span class="sc">%&gt;%</span> </span>
<span id="cb28-84"><a href="figure-4.html#cb28-84" tabindex="-1"></a>                        <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">&quot;GSM&quot;</span>),annotated_genes)  <span class="sc">%&gt;%</span> </span>
<span id="cb28-85"><a href="figure-4.html#cb28-85" tabindex="-1"></a>                        <span class="fu">group_by</span>(annotated_genes) <span class="sc">%&gt;%</span> <span class="fu">summarise_each</span>(<span class="fu">funs</span>(mean))</span>
<span id="cb28-86"><a href="figure-4.html#cb28-86" tabindex="-1"></a>    <span class="co"># show the paired methylation &amp; expression ,one by one</span></span>
<span id="cb28-87"><a href="figure-4.html#cb28-87" tabindex="-1"></a>    SME <span class="ot">&lt;-</span> pbapply<span class="sc">::</span><span class="fu">pblapply</span>(mid,<span class="cf">function</span>(m) {</span>
<span id="cb28-88"><a href="figure-4.html#cb28-88" tabindex="-1"></a>            <span class="co"># mean vs median</span></span>
<span id="cb28-89"><a href="figure-4.html#cb28-89" tabindex="-1"></a>              <span class="cf">if</span>(<span class="dv">1</span>){</span>
<span id="cb28-90"><a href="figure-4.html#cb28-90" tabindex="-1"></a>                ExM <span class="ot">&lt;-</span> <span class="cf">function</span>(z) <span class="fu">mean</span>(z, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-91"><a href="figure-4.html#cb28-91" tabindex="-1"></a>              }<span class="cf">else</span>{</span>
<span id="cb28-92"><a href="figure-4.html#cb28-92" tabindex="-1"></a>                ExM <span class="ot">&lt;-</span> <span class="cf">function</span>(z) <span class="fu">median</span>(z, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-93"><a href="figure-4.html#cb28-93" tabindex="-1"></a>              }</span>
<span id="cb28-94"><a href="figure-4.html#cb28-94" tabindex="-1"></a>             <span class="fu">cat</span>(<span class="st">&quot;Processing&quot;</span>,m,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-95"><a href="figure-4.html#cb28-95" tabindex="-1"></a>            <span class="co"># Methylation</span></span>
<span id="cb28-96"><a href="figure-4.html#cb28-96" tabindex="-1"></a>            data_Me <span class="ot">&lt;-</span>  data_methyl  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(variable<span class="sc">==</span>m) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(MM) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() </span>
<span id="cb28-97"><a href="figure-4.html#cb28-97" tabindex="-1"></a>            data_MHB <span class="ot">&lt;-</span>  scMethyl_MHB.GR <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(m,<span class="st">&quot;annotated_genes&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-98"><a href="figure-4.html#cb28-98" tabindex="-1"></a>                          <span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;value&quot;</span>,<span class="st">&quot;SYMBOL&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">ifelse</span>(value<span class="sc">&gt;=</span><span class="fl">0.8</span>,<span class="st">&quot;high&quot;</span>,</span>
<span id="cb28-99"><a href="figure-4.html#cb28-99" tabindex="-1"></a>                                                                            <span class="fu">ifelse</span>(value<span class="sc">&lt;=</span><span class="fl">0.2</span>,<span class="st">&quot;low&quot;</span>,<span class="st">&quot;intermediate&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb28-100"><a href="figure-4.html#cb28-100" tabindex="-1"></a>                          <span class="fu">group_by</span>(type) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">genes=</span><span class="fu">paste0</span>(SYMBOL, <span class="at">collapse=</span><span class="st">&quot;,&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb28-101"><a href="figure-4.html#cb28-101" tabindex="-1"></a>            <span class="co"># Exp</span></span>
<span id="cb28-102"><a href="figure-4.html#cb28-102" tabindex="-1"></a>            <span class="do">## test the RNA data  with paired Exp id</span></span>
<span id="cb28-103"><a href="figure-4.html#cb28-103" tabindex="-1"></a>                eid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">str_detect</span>(Methyl_ID,m)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Exp_ID) </span>
<span id="cb28-104"><a href="figure-4.html#cb28-104" tabindex="-1"></a>                <span class="cf">if</span>(<span class="fu">sum</span>(<span class="fu">str_detect</span>(<span class="fu">names</span>(RNA.TPM),eid))<span class="sc">==</span><span class="dv">1</span>){</span>
<span id="cb28-105"><a href="figure-4.html#cb28-105" tabindex="-1"></a>                    RNA <span class="ot">&lt;-</span> RNA.TPM</span>
<span id="cb28-106"><a href="figure-4.html#cb28-106" tabindex="-1"></a>                    <span class="fu">cat</span>(<span class="st">&quot;RNA_TPM &quot;</span>,x, <span class="st">&quot; &quot;</span>,m, <span class="st">&quot; &quot;</span>, eid,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-107"><a href="figure-4.html#cb28-107" tabindex="-1"></a>                    flag<span class="ot">&lt;-</span><span class="st">&quot;TPM&quot;</span></span>
<span id="cb28-108"><a href="figure-4.html#cb28-108" tabindex="-1"></a>                }<span class="cf">else</span>{</span>
<span id="cb28-109"><a href="figure-4.html#cb28-109" tabindex="-1"></a>                    RNA <span class="ot">&lt;-</span> RNA.FPKM</span>
<span id="cb28-110"><a href="figure-4.html#cb28-110" tabindex="-1"></a>                    <span class="fu">cat</span>(<span class="st">&quot;RNA_FPKM &quot;</span>,x, <span class="st">&quot; &quot;</span>,m, <span class="st">&quot; &quot;</span>, eid,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-111"><a href="figure-4.html#cb28-111" tabindex="-1"></a>                    flag <span class="ot">&lt;-</span><span class="st">&quot;FPKM&quot;</span></span>
<span id="cb28-112"><a href="figure-4.html#cb28-112" tabindex="-1"></a>                }</span>
<span id="cb28-113"><a href="figure-4.html#cb28-113" tabindex="-1"></a>                <span class="co"># two groups</span></span>
<span id="cb28-114"><a href="figure-4.html#cb28-114" tabindex="-1"></a>                <span class="co"># 1. promoter intermediate methylation </span></span>
<span id="cb28-115"><a href="figure-4.html#cb28-115" tabindex="-1"></a>                <span class="co"># MHB high  methylation </span></span>
<span id="cb28-116"><a href="figure-4.html#cb28-116" tabindex="-1"></a>                MHB_h <span class="ot">&lt;-</span> data_MHB <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type<span class="sc">==</span><span class="st">&quot;high&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(genes) <span class="sc">%&gt;%</span> <span class="fu">str_split_1</span>(<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>) </span>
<span id="cb28-117"><a href="figure-4.html#cb28-117" tabindex="-1"></a>                <span class="co"># MHB low  methylation</span></span>
<span id="cb28-118"><a href="figure-4.html#cb28-118" tabindex="-1"></a>                MHB_l <span class="ot">&lt;-</span> data_MHB <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type<span class="sc">==</span><span class="st">&quot;low&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(genes) <span class="sc">%&gt;%</span> <span class="fu">str_split_1</span>(<span class="at">pattern=</span><span class="st">&quot;,&quot;</span>) </span>
<span id="cb28-119"><a href="figure-4.html#cb28-119" tabindex="-1"></a></span>
<span id="cb28-120"><a href="figure-4.html#cb28-120" tabindex="-1"></a>                data_Me1 <span class="ot">&lt;-</span> data_Me <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">MHB_Methyl =</span> <span class="fu">ifelse</span>(SYMBOL <span class="sc">%in%</span> MHB_h ,<span class="st">&quot;High&quot;</span>,</span>
<span id="cb28-121"><a href="figure-4.html#cb28-121" tabindex="-1"></a>                                                <span class="fu">ifelse</span>(SYMBOL <span class="sc">%in%</span> MHB_l,<span class="st">&quot;Low&quot;</span>,<span class="st">&quot;Other&quot;</span>)))  <span class="sc">%&gt;%</span> </span>
<span id="cb28-122"><a href="figure-4.html#cb28-122" tabindex="-1"></a>                                        <span class="fu">filter</span>(MHB_Methyl<span class="sc">!=</span><span class="st">&quot;Other&quot;</span>,type<span class="sc">!=</span><span class="st">&quot;high&quot;</span>)</span>
<span id="cb28-123"><a href="figure-4.html#cb28-123" tabindex="-1"></a>                </span>
<span id="cb28-124"><a href="figure-4.html#cb28-124" tabindex="-1"></a>                IE <span class="ot">&lt;-</span> RNA <span class="sc">%&gt;%</span>  <span class="fu">select</span>(<span class="fu">contains</span>(eid)) <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;SYMBOL&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-125"><a href="figure-4.html#cb28-125" tabindex="-1"></a>                         <span class="fu">mutate</span>(<span class="at">EID =</span> eid,<span class="at">flag=</span>flag) <span class="sc">%&gt;%</span> <span class="fu">inner_join</span>(data_Me1,<span class="at">by=</span><span class="st">&quot;SYMBOL&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-126"><a href="figure-4.html#cb28-126" tabindex="-1"></a>                         dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;SYMBOL&quot;</span>,<span class="st">&quot;Exp&quot;</span>,<span class="st">&quot;EID&quot;</span>,<span class="st">&quot;flag&quot;</span>,<span class="st">&quot;MHB&quot;</span>,<span class="st">&quot;TSS_MM&quot;</span>,<span class="st">&quot;TSS_type&quot;</span>,<span class="st">&quot;MHB_type&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-127"><a href="figure-4.html#cb28-127" tabindex="-1"></a>                         <span class="fu">group_by</span>(TSS_type,EID,MHB_type,flag) <span class="sc">%&gt;%</span> </span>
<span id="cb28-128"><a href="figure-4.html#cb28-128" tabindex="-1"></a>                         <span class="fu">summarise</span>(<span class="at">Exp=</span><span class="fu">ExM</span>(Exp),<span class="at">ncount=</span><span class="fu">length</span>(SYMBOL)) </span>
<span id="cb28-129"><a href="figure-4.html#cb28-129" tabindex="-1"></a>    })</span>
<span id="cb28-130"><a href="figure-4.html#cb28-130" tabindex="-1"></a>     </span>
<span id="cb28-131"><a href="figure-4.html#cb28-131" tabindex="-1"></a>          <span class="fu">names</span>(SME) <span class="ot">&lt;-</span> mid</span>
<span id="cb28-132"><a href="figure-4.html#cb28-132" tabindex="-1"></a>          <span class="co"># cancer type : promoter methyltion + MHB + Expression </span></span>
<span id="cb28-133"><a href="figure-4.html#cb28-133" tabindex="-1"></a>           CME <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind,SME) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-134"><a href="figure-4.html#cb28-134" tabindex="-1"></a>                  dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;TSS_type&quot;</span>,<span class="st">&quot;EID&quot;</span>,<span class="st">&quot;MHB&quot;</span>,<span class="st">&quot;flag&quot;</span>,<span class="st">&quot;Exp&quot;</span>,<span class="st">&quot;ncount&quot;</span>))</span>
<span id="cb28-135"><a href="figure-4.html#cb28-135" tabindex="-1"></a>                    </span>
<span id="cb28-136"><a href="figure-4.html#cb28-136" tabindex="-1"></a>})</span>
<span id="cb28-137"><a href="figure-4.html#cb28-137" tabindex="-1"></a><span class="fu">names</span>(scMme) <span class="ot">&lt;-</span> tag </span>
<span id="cb28-138"><a href="figure-4.html#cb28-138" tabindex="-1"></a><span class="co"># sc_MMET: Tumor Methylation + MHB + Exp</span></span>
<span id="cb28-139"><a href="figure-4.html#cb28-139" tabindex="-1"></a>GSE97693_scME_MHBGene <span class="ot">&lt;-</span> scMme </span>
<span id="cb28-140"><a href="figure-4.html#cb28-140" tabindex="-1"></a><span class="co"># Step3: PLOT</span></span>
<span id="cb28-141"><a href="figure-4.html#cb28-141" tabindex="-1"></a>n<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb28-142"><a href="figure-4.html#cb28-142" tabindex="-1"></a><span class="cf">for</span> ( x <span class="cf">in</span> tag ){</span>
<span id="cb28-143"><a href="figure-4.html#cb28-143" tabindex="-1"></a></span>
<span id="cb28-144"><a href="figure-4.html#cb28-144" tabindex="-1"></a>    <span class="fu">cat</span>(x,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-145"><a href="figure-4.html#cb28-145" tabindex="-1"></a>    n <span class="ot">=</span> n <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb28-146"><a href="figure-4.html#cb28-146" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(GSE97693_scME_MHBGene[[x]])){   <span class="do">###check is null</span></span>
<span id="cb28-147"><a href="figure-4.html#cb28-147" tabindex="-1"></a></span>
<span id="cb28-148"><a href="figure-4.html#cb28-148" tabindex="-1"></a>      data <span class="ot">&lt;-</span> GSE97693_scME_MHBGene[[x]] <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Exp=</span><span class="fu">log2</span>(Exp<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb28-149"><a href="figure-4.html#cb28-149" tabindex="-1"></a>      <span class="do">## plot</span></span>
<span id="cb28-150"><a href="figure-4.html#cb28-150" tabindex="-1"></a>        <span class="fu">compare_means</span>(Exp <span class="sc">~</span> MHB, <span class="at">data =</span> data, <span class="at">group.by =</span> <span class="fu">c</span>(<span class="st">&quot;TSS_type&quot;</span>,<span class="st">&quot;flag&quot;</span>))</span>
<span id="cb28-151"><a href="figure-4.html#cb28-151" tabindex="-1"></a>        <span class="fu">assign</span>(<span class="fu">paste0</span>(<span class="st">&quot;p&quot;</span>,n),<span class="fu">ggboxplot</span>(data, <span class="at">x =</span> <span class="st">&quot;TSS_type&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Exp&quot;</span>,<span class="at">color=</span><span class="st">&quot;MHB&quot;</span>,</span>
<span id="cb28-152"><a href="figure-4.html#cb28-152" tabindex="-1"></a>                        <span class="at">palette =</span><span class="st">&quot;nejm&quot;</span>,<span class="at">width=</span><span class="fl">0.8</span>,</span>
<span id="cb28-153"><a href="figure-4.html#cb28-153" tabindex="-1"></a>                        <span class="at">bxp.errorbar =</span> T,</span>
<span id="cb28-154"><a href="figure-4.html#cb28-154" tabindex="-1"></a>                        <span class="at">add =</span> <span class="st">&quot;jitter&quot;</span>,</span>
<span id="cb28-155"><a href="figure-4.html#cb28-155" tabindex="-1"></a>                        <span class="at">add.params =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="fl">0.1</span>),</span>
<span id="cb28-156"><a href="figure-4.html#cb28-156" tabindex="-1"></a>                        <span class="at">facet.by =</span> <span class="fu">c</span>(<span class="st">&quot;flag&quot;</span>), <span class="at">short.panel.labs =</span> <span class="cn">FALSE</span></span>
<span id="cb28-157"><a href="figure-4.html#cb28-157" tabindex="-1"></a>                        ) <span class="sc">+</span></span>
<span id="cb28-158"><a href="figure-4.html#cb28-158" tabindex="-1"></a>                        <span class="fu">xlab</span>(<span class="st">&quot;Promoter Methylation-level&quot;</span>)<span class="sc">+</span> </span>
<span id="cb28-159"><a href="figure-4.html#cb28-159" tabindex="-1"></a>                        <span class="fu">ylab</span>(<span class="st">&quot;Expression&quot;</span>)<span class="sc">+</span></span>
<span id="cb28-160"><a href="figure-4.html#cb28-160" tabindex="-1"></a>                        <span class="fu">ggtitle</span>(<span class="fu">ifelse</span>(x<span class="sc">==</span><span class="st">&quot;Tumor&quot;</span>,<span class="st">&quot;Tumor&quot;</span>,x))<span class="sc">+</span> </span>
<span id="cb28-161"><a href="figure-4.html#cb28-161" tabindex="-1"></a>                        <span class="fu">stat_compare_means</span>(<span class="fu">aes</span>(<span class="at">group =</span> MHB),<span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb28-162"><a href="figure-4.html#cb28-162" tabindex="-1"></a>                        <span class="fu">theme_bw</span>() <span class="sc">+</span>    </span>
<span id="cb28-163"><a href="figure-4.html#cb28-163" tabindex="-1"></a>                        <span class="fu">theme</span>(<span class="at">panel.grid.major=</span><span class="fu">element_line</span>(<span class="at">colour=</span><span class="cn">NA</span>),</span>
<span id="cb28-164"><a href="figure-4.html#cb28-164" tabindex="-1"></a>                        <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>,<span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb28-165"><a href="figure-4.html#cb28-165" tabindex="-1"></a>                        <span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">&quot;transparent&quot;</span>,<span class="at">colour =</span> <span class="cn">NA</span>),</span>
<span id="cb28-166"><a href="figure-4.html#cb28-166" tabindex="-1"></a>                        <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb28-167"><a href="figure-4.html#cb28-167" tabindex="-1"></a>                        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>,<span class="at">vjust =</span> <span class="dv">1</span>,<span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb28-168"><a href="figure-4.html#cb28-168" tabindex="-1"></a>                        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb28-169"><a href="figure-4.html#cb28-169" tabindex="-1"></a>                        <span class="at">panel.border =</span> <span class="fu">element_rect</span>(<span class="at">fill=</span><span class="cn">NA</span>,<span class="at">color=</span><span class="st">&quot;black&quot;</span>, <span class="at">size=</span><span class="dv">1</span>, <span class="at">linetype=</span><span class="st">&quot;solid&quot;</span>))</span>
<span id="cb28-170"><a href="figure-4.html#cb28-170" tabindex="-1"></a>             )</span>
<span id="cb28-171"><a href="figure-4.html#cb28-171" tabindex="-1"></a>             <span class="fu">cat</span>(n,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb28-172"><a href="figure-4.html#cb28-172" tabindex="-1"></a>    }</span>
<span id="cb28-173"><a href="figure-4.html#cb28-173" tabindex="-1"></a>}</span>
<span id="cb28-174"><a href="figure-4.html#cb28-174" tabindex="-1"></a><span class="co"># paste to one figure </span></span>
<span id="cb28-175"><a href="figure-4.html#cb28-175" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p1, p2, p3, p4,p5)</span>
<span id="cb28-176"><a href="figure-4.html#cb28-176" tabindex="-1"></a><span class="fu">ggsave</span>(p,<span class="at">filename=</span><span class="fu">paste0</span>(<span class="st">&quot;Data/Figures/Fig4/Fig4.F.pdf&quot;</span>),<span class="at">width=</span><span class="dv">14</span>,<span class="at">height=</span><span class="dv">6</span>)</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-53"></span>
<img src="Data/Figures/Fig4/Fig4.F.png" alt="Fig4.F" width="90%" id="fig-unnamed-chunk-53-1" />
<p class="caption">
 4.5: Fig4.F
</p>
</div>
</div>
<div id="i-j.-mhbs-and-dysregulation-of-gene-expression-in-crc." class="section level2 hasAnchor" number="4.6">
<h2><span class="header-section-number">4.6</span> (I-J). MHBs and dysregulation of gene expression in CRC.<a href="figure-4.html#i-j.-mhbs-and-dysregulation-of-gene-expression-in-crc." class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="figure-4.html#cb29-1" tabindex="-1"></a><span class="co"># Step1: Single-cell Expression</span></span>
<span id="cb29-2"><a href="figure-4.html#cb29-2" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;scMHB_GSE97693/Exp/GSE97693_scRNA_TPM_FPKM.RData&quot;</span>)</span>
<span id="cb29-3"><a href="figure-4.html#cb29-3" tabindex="-1"></a><span class="co"># select the single cell with TPM data. (only with PT, LN, and Normal cell)</span></span>
<span id="cb29-4"><a href="figure-4.html#cb29-4" tabindex="-1"></a>  <span class="cf">if</span>(<span class="dv">0</span>){</span>
<span id="cb29-5"><a href="figure-4.html#cb29-5" tabindex="-1"></a>      RNA <span class="ot">&lt;-</span> RNA.FPKM</span>
<span id="cb29-6"><a href="figure-4.html#cb29-6" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">&quot;RNA FPKM &quot;</span>,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb29-7"><a href="figure-4.html#cb29-7" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb29-8"><a href="figure-4.html#cb29-8" tabindex="-1"></a>      RNA <span class="ot">&lt;-</span> RNA.TPM</span>
<span id="cb29-9"><a href="figure-4.html#cb29-9" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">&quot;RNA TPM &quot;</span>,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb29-10"><a href="figure-4.html#cb29-10" tabindex="-1"></a>  }</span>
<span id="cb29-11"><a href="figure-4.html#cb29-11" tabindex="-1"></a><span class="fu">names</span>(RNA) <span class="ot">&lt;-</span> <span class="fu">str_split_i</span>(<span class="fu">names</span>(RNA),<span class="st">&quot;_&quot;</span>,<span class="at">i=</span><span class="dv">1</span>)</span>
<span id="cb29-12"><a href="figure-4.html#cb29-12" tabindex="-1"></a><span class="co"># load meta data</span></span>
<span id="cb29-13"><a href="figure-4.html#cb29-13" tabindex="-1"></a>id <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Anno/GSE97693_Anno.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> </span>
<span id="cb29-14"><a href="figure-4.html#cb29-14" tabindex="-1"></a>      <span class="fu">select</span>(ID,patients,lesions,assay,tissue,tag) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">!=</span><span class="st">&quot;HeLa&quot;</span>) </span>
<span id="cb29-15"><a href="figure-4.html#cb29-15" tabindex="-1"></a>id.RNA <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ID  <span class="sc">%in%</span> <span class="fu">names</span>(RNA)) </span>
<span id="cb29-16"><a href="figure-4.html#cb29-16" tabindex="-1"></a><span class="co"># Find DEG Markers</span></span>
<span id="cb29-17"><a href="figure-4.html#cb29-17" tabindex="-1"></a>findDEG <span class="ot">&lt;-</span> <span class="cf">function</span>(x,Idents) {</span>
<span id="cb29-18"><a href="figure-4.html#cb29-18" tabindex="-1"></a>    <span class="co"># annotation</span></span>
<span id="cb29-19"><a href="figure-4.html#cb29-19" tabindex="-1"></a>    treat <span class="ot">&lt;-</span> id.RNA <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">str_detect</span>(tissue,Idents)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-20"><a href="figure-4.html#cb29-20" tabindex="-1"></a>    nc <span class="ot">&lt;-</span> id.RNA <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;NC&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-21"><a href="figure-4.html#cb29-21" tabindex="-1"></a>    <span class="co"># wilcoxon test</span></span>
<span id="cb29-22"><a href="figure-4.html#cb29-22" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <span class="cf">function</span>(z) {</span>
<span id="cb29-23"><a href="figure-4.html#cb29-23" tabindex="-1"></a>    d1 <span class="ot">&lt;-</span> z[treat]<span class="sc">%&gt;%</span> <span class="fu">as.character</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb29-24"><a href="figure-4.html#cb29-24" tabindex="-1"></a>    d2 <span class="ot">&lt;-</span> z[nc] <span class="sc">%&gt;%</span> <span class="fu">as.character</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb29-25"><a href="figure-4.html#cb29-25" tabindex="-1"></a></span>
<span id="cb29-26"><a href="figure-4.html#cb29-26" tabindex="-1"></a>    p <span class="ot">&lt;-</span>  <span class="fu">wilcox.test</span>(d1,d2)<span class="sc">$</span>p.value</span>
<span id="cb29-27"><a href="figure-4.html#cb29-27" tabindex="-1"></a>    group1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(d1)</span>
<span id="cb29-28"><a href="figure-4.html#cb29-28" tabindex="-1"></a>    group2 <span class="ot">&lt;-</span> <span class="fu">mean</span>(d2)</span>
<span id="cb29-29"><a href="figure-4.html#cb29-29" tabindex="-1"></a>    logFC <span class="ot">&lt;-</span> <span class="fu">log2</span>(group1<span class="sc">+</span><span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log2</span>(group2<span class="sc">+</span><span class="dv">1</span>)  </span>
<span id="cb29-30"><a href="figure-4.html#cb29-30" tabindex="-1"></a>    </span>
<span id="cb29-31"><a href="figure-4.html#cb29-31" tabindex="-1"></a>    <span class="fu">c</span>(group1,group2,logFC,p)</span>
<span id="cb29-32"><a href="figure-4.html#cb29-32" tabindex="-1"></a>    }</span>
<span id="cb29-33"><a href="figure-4.html#cb29-33" tabindex="-1"></a>    </span>
<span id="cb29-34"><a href="figure-4.html#cb29-34" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(x,<span class="dv">1</span>,z)) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;Treat&quot;</span>,<span class="st">&quot;NC&quot;</span>,<span class="st">&quot;logFC&quot;</span>,<span class="st">&quot;p_value&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb29-35"><a href="figure-4.html#cb29-35" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">p_val_adj=</span><span class="fu">p.adjust</span>(p_value,<span class="at">method=</span><span class="st">&quot;fdr&quot;</span>,<span class="fu">length</span>(p_value)),</span>
<span id="cb29-36"><a href="figure-4.html#cb29-36" tabindex="-1"></a>                   <span class="at">DEG =</span> <span class="fu">ifelse</span>(<span class="fu">abs</span>(logFC)<span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> p_val_adj<span class="sc">&lt;=</span><span class="fl">0.05</span>,<span class="st">&quot;Yes&quot;</span>,<span class="st">&quot;No&quot;</span>))</span>
<span id="cb29-37"><a href="figure-4.html#cb29-37" tabindex="-1"></a>    <span class="fu">return</span>(res)</span>
<span id="cb29-38"><a href="figure-4.html#cb29-38" tabindex="-1"></a>}</span>
<span id="cb29-39"><a href="figure-4.html#cb29-39" tabindex="-1"></a></span>
<span id="cb29-40"><a href="figure-4.html#cb29-40" tabindex="-1"></a>PT.markers <span class="ot">&lt;-</span> <span class="fu">findDEG</span>(RNA,<span class="at">Idents=</span><span class="st">&quot;PT&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;SYMBOL&quot;</span>)</span>
<span id="cb29-41"><a href="figure-4.html#cb29-41" tabindex="-1"></a>LN.markers <span class="ot">&lt;-</span> <span class="fu">findDEG</span>(RNA,<span class="at">Idents=</span><span class="st">&quot;LN&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;SYMBOL&quot;</span>)</span>
<span id="cb29-42"><a href="figure-4.html#cb29-42" tabindex="-1"></a><span class="co"># Step2: promoter DNA methylation</span></span>
<span id="cb29-43"><a href="figure-4.html#cb29-43" tabindex="-1"></a><span class="fu">library</span>(regioneR)</span>
<span id="cb29-44"><a href="figure-4.html#cb29-44" tabindex="-1"></a><span class="fu">library</span>(pbapply)</span>
<span id="cb29-45"><a href="figure-4.html#cb29-45" tabindex="-1"></a>scMethyl_Mcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/promoter_methylated.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-46"><a href="figure-4.html#cb29-46" tabindex="-1"></a>                    <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb29-47"><a href="figure-4.html#cb29-47" tabindex="-1"></a>scMethyl_Tcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/promoter_total.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-48"><a href="figure-4.html#cb29-48" tabindex="-1"></a>                    <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb29-49"><a href="figure-4.html#cb29-49" tabindex="-1"></a><span class="co"># filter promoters with Total reads count &lt;3</span></span>
<span id="cb29-50"><a href="figure-4.html#cb29-50" tabindex="-1"></a>scMethyl_Tcounts[scMethyl_Tcounts<span class="sc">&lt;</span><span class="dv">3</span>]<span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb29-51"><a href="figure-4.html#cb29-51" tabindex="-1"></a>scMethyl <span class="ot">&lt;-</span> scMethyl_Mcounts<span class="sc">/</span>scMethyl_Tcounts </span>
<span id="cb29-52"><a href="figure-4.html#cb29-52" tabindex="-1"></a>scMethyl <span class="ot">&lt;-</span> scMethyl <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">separate</span>(region,<span class="at">into=</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),<span class="at">sep=</span><span class="st">&quot;[:-]&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb29-53"><a href="figure-4.html#cb29-53" tabindex="-1"></a>                         <span class="fu">mutate</span>(<span class="at">start=</span><span class="fu">as.numeric</span>(start)<span class="sc">-</span><span class="dv">1</span>,<span class="at">end=</span><span class="fu">as.numeric</span>(end))</span>
<span id="cb29-54"><a href="figure-4.html#cb29-54" tabindex="-1"></a><span class="co"># promoter anno</span></span>
<span id="cb29-55"><a href="figure-4.html#cb29-55" tabindex="-1"></a>Promoter <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;Data/Processed_data/GREATv4.genes.promoter_UD1000.hg19.bed&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-56"><a href="figure-4.html#cb29-56" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>,<span class="st">&quot;strand&quot;</span>,<span class="st">&quot;SYMBOL&quot;</span>))</span>
<span id="cb29-57"><a href="figure-4.html#cb29-57" tabindex="-1"></a>scMethyl <span class="ot">&lt;-</span> Promoter <span class="sc">%&gt;%</span> <span class="fu">inner_join</span>(scMethyl,<span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>))</span>
<span id="cb29-58"><a href="figure-4.html#cb29-58" tabindex="-1"></a>scMethyl.GR <span class="ot">&lt;-</span> <span class="fu">makeGRangesFromDataFrame</span>(scMethyl,<span class="at">keep.extra=</span>T)</span>
<span id="cb29-59"><a href="figure-4.html#cb29-59" tabindex="-1"></a><span class="co"># promoter overlap with MHB </span></span>
<span id="cb29-60"><a href="figure-4.html#cb29-60" tabindex="-1"></a>tag<span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;PT&quot;</span>,<span class="st">&quot;LN&quot;</span>)</span>
<span id="cb29-61"><a href="figure-4.html#cb29-61" tabindex="-1"></a>scMHB_Methyl <span class="ot">&lt;-</span> pbapply<span class="sc">::</span><span class="fu">pblapply</span>(tag,<span class="cf">function</span>(x){</span>
<span id="cb29-62"><a href="figure-4.html#cb29-62" tabindex="-1"></a>    path<span class="ot">=</span><span class="st">&quot;Data/Processed_data/MHB/singlecell/&quot;</span></span>
<span id="cb29-63"><a href="figure-4.html#cb29-63" tabindex="-1"></a>    MHB<span class="ot">&lt;-</span><span class="fu">toGRanges</span>(<span class="fu">paste0</span>(path,<span class="st">&quot;CRC_MHB_&quot;</span>,x,<span class="st">&quot;.bed&quot;</span>))</span>
<span id="cb29-64"><a href="figure-4.html#cb29-64" tabindex="-1"></a>    <span class="co"># overlapping</span></span>
<span id="cb29-65"><a href="figure-4.html#cb29-65" tabindex="-1"></a>    Tx <span class="ot">&lt;-</span> <span class="fu">findOverlaps</span>(scMethyl.GR,MHB,<span class="at">ignore.strand=</span>T)</span>
<span id="cb29-66"><a href="figure-4.html#cb29-66" tabindex="-1"></a>    a<span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,<span class="fu">length</span>(scMethyl.GR))</span>
<span id="cb29-67"><a href="figure-4.html#cb29-67" tabindex="-1"></a>    <span class="co"># MHB </span></span>
<span id="cb29-68"><a href="figure-4.html#cb29-68" tabindex="-1"></a>    a[<span class="fu">unique</span>(<span class="fu">queryHits</span>(Tx))]<span class="ot">&lt;-</span><span class="st">&quot;T&quot;</span></span>
<span id="cb29-69"><a href="figure-4.html#cb29-69" tabindex="-1"></a>    a[<span class="fu">is.na</span>(a)]<span class="ot">&lt;-</span><span class="st">&quot;N&quot;</span></span>
<span id="cb29-70"><a href="figure-4.html#cb29-70" tabindex="-1"></a>    a<span class="ot">&lt;-</span> a <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb29-71"><a href="figure-4.html#cb29-71" tabindex="-1"></a>    <span class="fu">names</span>(a)<span class="ot">&lt;-</span><span class="st">&quot;MHB&quot;</span></span>
<span id="cb29-72"><a href="figure-4.html#cb29-72" tabindex="-1"></a>    <span class="co"># sample GSM ID paired data</span></span>
<span id="cb29-73"><a href="figure-4.html#cb29-73" tabindex="-1"></a>    sid <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">str_detect</span>(tissue,x),assay<span class="sc">==</span><span class="st">&quot;Met&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-74"><a href="figure-4.html#cb29-74" tabindex="-1"></a>    nc <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;NC&quot;</span>,assay<span class="sc">==</span><span class="st">&quot;Met&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-75"><a href="figure-4.html#cb29-75" tabindex="-1"></a></span>
<span id="cb29-76"><a href="figure-4.html#cb29-76" tabindex="-1"></a>    ids <span class="ot">&lt;-</span> <span class="fu">c</span>(sid,nc)</span>
<span id="cb29-77"><a href="figure-4.html#cb29-77" tabindex="-1"></a>    <span class="co"># select</span></span>
<span id="cb29-78"><a href="figure-4.html#cb29-78" tabindex="-1"></a>    <span class="fu">mcols</span>(scMethyl.GR) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb29-79"><a href="figure-4.html#cb29-79" tabindex="-1"></a>                            <span class="fu">select</span>(SYMBOL,<span class="fu">all_of</span>(ids)) <span class="sc">%&gt;%</span></span>
<span id="cb29-80"><a href="figure-4.html#cb29-80" tabindex="-1"></a>                            <span class="fu">cbind</span>(a) </span>
<span id="cb29-81"><a href="figure-4.html#cb29-81" tabindex="-1"></a>})</span>
<span id="cb29-82"><a href="figure-4.html#cb29-82" tabindex="-1"></a><span class="fu">names</span>(scMHB_Methyl) <span class="ot">&lt;-</span>tag</span>
<span id="cb29-83"><a href="figure-4.html#cb29-83" tabindex="-1"></a><span class="co"># find Promoter DMR markers</span></span>
<span id="cb29-84"><a href="figure-4.html#cb29-84" tabindex="-1"></a><span class="co"># Remove NA</span></span>
<span id="cb29-85"><a href="figure-4.html#cb29-85" tabindex="-1"></a>sum_of_na <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb29-86"><a href="figure-4.html#cb29-86" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">is.na</span>(x))</span>
<span id="cb29-87"><a href="figure-4.html#cb29-87" tabindex="-1"></a>}</span>
<span id="cb29-88"><a href="figure-4.html#cb29-88" tabindex="-1"></a>target_genes <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb29-89"><a href="figure-4.html#cb29-89" tabindex="-1"></a>      Mm <span class="ot">&lt;-</span> <span class="fu">apply</span>(x,<span class="dv">1</span>,sum_of_na) <span class="sc">&gt;</span> <span class="fl">0.9</span><span class="sc">*</span><span class="fu">ncol</span>(x)  <span class="co"># promoter:0.3, MHB:0.9</span></span>
<span id="cb29-90"><a href="figure-4.html#cb29-90" tabindex="-1"></a>      genes <span class="ot">&lt;-</span> x<span class="sc">$</span>SYMBOL[Mm<span class="sc">!=</span><span class="st">&quot;TRUE&quot;</span>]</span>
<span id="cb29-91"><a href="figure-4.html#cb29-91" tabindex="-1"></a>      <span class="fu">return</span>(genes)</span>
<span id="cb29-92"><a href="figure-4.html#cb29-92" tabindex="-1"></a>}</span>
<span id="cb29-93"><a href="figure-4.html#cb29-93" tabindex="-1"></a></span>
<span id="cb29-94"><a href="figure-4.html#cb29-94" tabindex="-1"></a>findDMGenes <span class="ot">&lt;-</span> <span class="cf">function</span>(dataset,Idents){</span>
<span id="cb29-95"><a href="figure-4.html#cb29-95" tabindex="-1"></a>    <span class="co"># annotation</span></span>
<span id="cb29-96"><a href="figure-4.html#cb29-96" tabindex="-1"></a>    treat <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">str_detect</span>(tissue,Idents),assay<span class="sc">==</span><span class="st">&quot;Met&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-97"><a href="figure-4.html#cb29-97" tabindex="-1"></a>    nc <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;NC&quot;</span>,assay<span class="sc">==</span><span class="st">&quot;Met&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-98"><a href="figure-4.html#cb29-98" tabindex="-1"></a>    <span class="co"># dataset 1 &amp; dataset 2 merging</span></span>
<span id="cb29-99"><a href="figure-4.html#cb29-99" tabindex="-1"></a>    dataset1 <span class="ot">&lt;-</span> dataset[[Idents]] <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(SYMBOL,MHB,<span class="fu">all_of</span>(treat)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(SYMBOL <span class="sc">%in%</span> <span class="fu">target_genes</span>(.)) </span>
<span id="cb29-100"><a href="figure-4.html#cb29-100" tabindex="-1"></a>    dataset2 <span class="ot">&lt;-</span> dataset[[Idents]] <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(SYMBOL,<span class="fu">all_of</span>(nc)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(SYMBOL <span class="sc">%in%</span> <span class="fu">target_genes</span>(.))</span>
<span id="cb29-101"><a href="figure-4.html#cb29-101" tabindex="-1"></a>    data <span class="ot">&lt;-</span>  <span class="fu">inner_join</span>(dataset1,dataset2,<span class="at">by=</span><span class="st">&quot;SYMBOL&quot;</span>) </span>
<span id="cb29-102"><a href="figure-4.html#cb29-102" tabindex="-1"></a>    <span class="co"># find DMG</span></span>
<span id="cb29-103"><a href="figure-4.html#cb29-103" tabindex="-1"></a>    dmg <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb29-104"><a href="figure-4.html#cb29-104" tabindex="-1"></a></span>
<span id="cb29-105"><a href="figure-4.html#cb29-105" tabindex="-1"></a>        d1 <span class="ot">&lt;-</span> x[treat]<span class="sc">%&gt;%</span> <span class="fu">as.character</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb29-106"><a href="figure-4.html#cb29-106" tabindex="-1"></a>        d2 <span class="ot">&lt;-</span> x[nc] <span class="sc">%&gt;%</span> <span class="fu">as.character</span>() <span class="sc">%&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb29-107"><a href="figure-4.html#cb29-107" tabindex="-1"></a></span>
<span id="cb29-108"><a href="figure-4.html#cb29-108" tabindex="-1"></a>        p <span class="ot">&lt;-</span>  <span class="fu">wilcox.test</span>(d1,d2)<span class="sc">$</span>p.value</span>
<span id="cb29-109"><a href="figure-4.html#cb29-109" tabindex="-1"></a>        delta <span class="ot">&lt;-</span> <span class="fu">mean</span>(d1,<span class="at">na.rm=</span>T) <span class="sc">-</span> <span class="fu">mean</span>(d2,<span class="at">na.rm=</span>T)</span>
<span id="cb29-110"><a href="figure-4.html#cb29-110" tabindex="-1"></a>        res <span class="ot">&lt;-</span> <span class="fu">c</span>(delta,p)</span>
<span id="cb29-111"><a href="figure-4.html#cb29-111" tabindex="-1"></a>        <span class="fu">return</span>(res)</span>
<span id="cb29-112"><a href="figure-4.html#cb29-112" tabindex="-1"></a>    }</span>
<span id="cb29-113"><a href="figure-4.html#cb29-113" tabindex="-1"></a></span>
<span id="cb29-114"><a href="figure-4.html#cb29-114" tabindex="-1"></a>    res <span class="ot">&lt;-</span>  <span class="fu">apply</span>(data,<span class="dv">1</span>,dmg) <span class="sc">%&gt;%</span> <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb29-115"><a href="figure-4.html#cb29-115" tabindex="-1"></a>                    <span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;delta&quot;</span>,<span class="st">&quot;P.val&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">fdr=</span><span class="fu">p.adjust</span>(P.val,<span class="at">n=</span><span class="fu">length</span>(P.val))) <span class="sc">%&gt;%</span> </span>
<span id="cb29-116"><a href="figure-4.html#cb29-116" tabindex="-1"></a>            <span class="fu">cbind</span>(data) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">DMG =</span> <span class="fu">ifelse</span>(<span class="fu">abs</span>(delta)<span class="sc">&gt;</span><span class="fl">0.1</span> <span class="sc">&amp;</span> fdr <span class="sc">&lt;=</span> <span class="fl">0.05</span>, <span class="st">&quot;Yes&quot;</span>,<span class="st">&quot;No&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-117"><a href="figure-4.html#cb29-117" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(SYMBOL,delta,P.val,fdr,DMG,MHB)</span>
<span id="cb29-118"><a href="figure-4.html#cb29-118" tabindex="-1"></a>    <span class="co"># Return</span></span>
<span id="cb29-119"><a href="figure-4.html#cb29-119" tabindex="-1"></a>    <span class="fu">return</span>(res)</span>
<span id="cb29-120"><a href="figure-4.html#cb29-120" tabindex="-1"></a>}</span>
<span id="cb29-121"><a href="figure-4.html#cb29-121" tabindex="-1"></a>DMG.PT<span class="ot">&lt;-</span> <span class="fu">findDMGenes</span>(scMHB_Methyl,<span class="at">Idents=</span><span class="st">&quot;PT&quot;</span>)</span>
<span id="cb29-122"><a href="figure-4.html#cb29-122" tabindex="-1"></a>DMG.LN<span class="ot">&lt;-</span> <span class="fu">findDMGenes</span>(scMHB_Methyl,<span class="at">Idents=</span><span class="st">&quot;LN&quot;</span>)</span>
<span id="cb29-123"><a href="figure-4.html#cb29-123" tabindex="-1"></a><span class="co"># Identify DEGs + NonDMR + MHB Genes </span></span>
<span id="cb29-124"><a href="figure-4.html#cb29-124" tabindex="-1"></a>            <span class="co"># PT</span></span>
<span id="cb29-125"><a href="figure-4.html#cb29-125" tabindex="-1"></a>            NonDMG.PT <span class="ot">&lt;-</span>  DMG.PT  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DMG<span class="sc">==</span><span class="st">&quot;No&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(SYMBOL,MHB)</span>
<span id="cb29-126"><a href="figure-4.html#cb29-126" tabindex="-1"></a>            DEG.PT <span class="ot">&lt;-</span>  PT.markers <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DEG<span class="sc">==</span><span class="st">&quot;Yes&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">DE =</span> <span class="fu">ifelse</span>(logFC <span class="sc">&gt;=</span> <span class="dv">1</span>,<span class="st">&quot;UP&quot;</span>,<span class="st">&quot;DN&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">select</span>(SYMBOL,DE)</span>
<span id="cb29-127"><a href="figure-4.html#cb29-127" tabindex="-1"></a>            data.PT<span class="ot">&lt;-</span> <span class="fu">inner_join</span>(DEG.PT,NonDMG.PT,<span class="at">by=</span><span class="st">&quot;SYMBOL&quot;</span>)</span>
<span id="cb29-128"><a href="figure-4.html#cb29-128" tabindex="-1"></a>            <span class="co"># LN            </span></span>
<span id="cb29-129"><a href="figure-4.html#cb29-129" tabindex="-1"></a>            NonDMG.LN <span class="ot">&lt;-</span>  DMG.LN <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DMG<span class="sc">==</span><span class="st">&quot;No&quot;</span>)  <span class="sc">%&gt;%</span> <span class="fu">select</span>(SYMBOL,MHB)</span>
<span id="cb29-130"><a href="figure-4.html#cb29-130" tabindex="-1"></a>            DEG.LN <span class="ot">&lt;-</span>  LN.markers <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DEG<span class="sc">==</span><span class="st">&quot;Yes&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">DE =</span> <span class="fu">ifelse</span>(logFC <span class="sc">&gt;=</span> <span class="dv">1</span>,<span class="st">&quot;UP&quot;</span>,<span class="st">&quot;DN&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">select</span>(SYMBOL,DE)</span>
<span id="cb29-131"><a href="figure-4.html#cb29-131" tabindex="-1"></a>            data.LN <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(DEG.LN,NonDMG.LN,<span class="at">by=</span><span class="st">&quot;SYMBOL&quot;</span>)</span>
<span id="cb29-132"><a href="figure-4.html#cb29-132" tabindex="-1"></a>            </span>
<span id="cb29-133"><a href="figure-4.html#cb29-133" tabindex="-1"></a>            PT.MHB.NonDMR.Up <span class="ot">&lt;-</span> data.PT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DE<span class="sc">==</span><span class="st">&quot;UP&quot;</span>,MHB<span class="sc">==</span><span class="st">&quot;T&quot;</span>)  <span class="sc">%&gt;%</span> <span class="fu">pull</span>(SYMBOL)</span>
<span id="cb29-134"><a href="figure-4.html#cb29-134" tabindex="-1"></a>            LN.MHB.NonDMR.Up <span class="ot">&lt;-</span>  data.LN <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DE<span class="sc">==</span><span class="st">&quot;UP&quot;</span>,MHB<span class="sc">==</span><span class="st">&quot;T&quot;</span>)  <span class="sc">%&gt;%</span> <span class="fu">pull</span>(SYMBOL)</span>
<span id="cb29-135"><a href="figure-4.html#cb29-135" tabindex="-1"></a></span>
<span id="cb29-136"><a href="figure-4.html#cb29-136" tabindex="-1"></a>            geneset <span class="ot">&lt;-</span>  <span class="fu">intersect</span>(PT.MHB.NonDMR.Up,LN.MHB.NonDMR.Up)</span>
<span id="cb29-137"><a href="figure-4.html#cb29-137" tabindex="-1"></a>            test <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;geneset&quot;</span><span class="ot">=</span>geneset)</span>
<span id="cb29-138"><a href="figure-4.html#cb29-138" tabindex="-1"></a><span class="co"># saving </span></span>
<span id="cb29-139"><a href="figure-4.html#cb29-139" tabindex="-1"></a>write_gmt <span class="ot">&lt;-</span> <span class="cf">function</span>(x,filename) {</span>
<span id="cb29-140"><a href="figure-4.html#cb29-140" tabindex="-1"></a>    </span>
<span id="cb29-141"><a href="figure-4.html#cb29-141" tabindex="-1"></a>    output<span class="ot">&lt;-</span><span class="fu">file</span>(filename,<span class="at">open =</span> <span class="st">&quot;wt&quot;</span>)</span>
<span id="cb29-142"><a href="figure-4.html#cb29-142" tabindex="-1"></a>    name <span class="ot">&lt;-</span> <span class="fu">names</span>(x)</span>
<span id="cb29-143"><a href="figure-4.html#cb29-143" tabindex="-1"></a>    <span class="fu">lapply</span>(name,<span class="cf">function</span>(y){</span>
<span id="cb29-144"><a href="figure-4.html#cb29-144" tabindex="-1"></a>          </span>
<span id="cb29-145"><a href="figure-4.html#cb29-145" tabindex="-1"></a>     <span class="fu">writeLines</span>(<span class="fu">paste</span>(<span class="fu">c</span>(y,<span class="st">&quot;NA&quot;</span>,x[[y]]),<span class="at">collapse =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>),<span class="at">con =</span> output)</span>
<span id="cb29-146"><a href="figure-4.html#cb29-146" tabindex="-1"></a>    </span>
<span id="cb29-147"><a href="figure-4.html#cb29-147" tabindex="-1"></a>     })</span>
<span id="cb29-148"><a href="figure-4.html#cb29-148" tabindex="-1"></a>    <span class="fu">close</span>(output)</span>
<span id="cb29-149"><a href="figure-4.html#cb29-149" tabindex="-1"></a>}</span>
<span id="cb29-150"><a href="figure-4.html#cb29-150" tabindex="-1"></a><span class="fu">write_gmt</span>(test,<span class="at">filename=</span><span class="st">&quot;PT-LN.MHB.NonDMR.Up.gmt&quot;</span>)</span>
<span id="cb29-151"><a href="figure-4.html#cb29-151" tabindex="-1"></a><span class="fu">fwrite</span>(<span class="fu">as.data.frame</span>(geneset),<span class="at">file=</span><span class="st">&quot;PT-LN.MHB.NonDMR.Up_geneset.txt&quot;</span>,<span class="at">sep=</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>,<span class="at">quote=</span>F,<span class="at">row.names=</span>F,<span class="at">col.names=</span>F) </span>
<span id="cb29-152"><a href="figure-4.html#cb29-152" tabindex="-1"></a><span class="co"># Step3: MHB Methylation</span></span>
<span id="cb29-153"><a href="figure-4.html#cb29-153" tabindex="-1"></a>promoter.GR <span class="ot">&lt;-</span> <span class="fu">toGRanges</span>(Promoter)</span>
<span id="cb29-154"><a href="figure-4.html#cb29-154" tabindex="-1"></a><span class="do">## PT</span></span>
<span id="cb29-155"><a href="figure-4.html#cb29-155" tabindex="-1"></a>scMethyl_MHB_PT_Mcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/GW/MHB_PT_extend_methylated.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb29-156"><a href="figure-4.html#cb29-156" tabindex="-1"></a>scMethyl_MHB_PT_Tcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/GW/MHB_PT_extend_total.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb29-157"><a href="figure-4.html#cb29-157" tabindex="-1"></a>scMethyl_MHB_PT_Tcounts[scMethyl_MHB_PT_Tcounts<span class="sc">&lt;</span><span class="dv">3</span>]<span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb29-158"><a href="figure-4.html#cb29-158" tabindex="-1"></a>scMethyl_MHB_PT <span class="ot">&lt;-</span> scMethyl_MHB_PT_Mcounts<span class="sc">/</span>scMethyl_MHB_PT_Tcounts </span>
<span id="cb29-159"><a href="figure-4.html#cb29-159" tabindex="-1"></a>scMethyl_MHB_PT <span class="ot">&lt;-</span> scMethyl_MHB_PT <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">separate</span>(region,<span class="at">into=</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),<span class="at">sep=</span><span class="st">&quot;[:-]&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb29-160"><a href="figure-4.html#cb29-160" tabindex="-1"></a>                         <span class="fu">mutate</span>(<span class="at">start=</span><span class="fu">as.numeric</span>(start)<span class="sc">-</span><span class="dv">1</span>,<span class="at">end=</span><span class="fu">as.numeric</span>(end))</span>
<span id="cb29-161"><a href="figure-4.html#cb29-161" tabindex="-1"></a>scMethyl_MHB_PT.GR <span class="ot">&lt;-</span> <span class="fu">makeGRangesFromDataFrame</span>(scMethyl_MHB_PT,<span class="at">keep.extra=</span>T) </span>
<span id="cb29-162"><a href="figure-4.html#cb29-162" tabindex="-1"></a><span class="co"># Overlapping</span></span>
<span id="cb29-163"><a href="figure-4.html#cb29-163" tabindex="-1"></a>x.PT <span class="ot">&lt;-</span> <span class="fu">findOverlaps</span>(promoter.GR,scMethyl_MHB_PT.GR,<span class="at">ignore.strand=</span>T)</span>
<span id="cb29-164"><a href="figure-4.html#cb29-164" tabindex="-1"></a>scMethyl_MHB_PT_TSS <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">mcols</span>(promoter.GR[<span class="fu">queryHits</span>(x.PT)])[<span class="st">&quot;SYMBOL&quot;</span>],<span class="fu">mcols</span>(scMethyl_MHB_PT.GR[<span class="fu">subjectHits</span>(x.PT)]))</span>
<span id="cb29-165"><a href="figure-4.html#cb29-165" tabindex="-1"></a>scMethyl_MHB_PT_TSS <span class="ot">&lt;-</span>  scMethyl_MHB_PT_TSS <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()  <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(SYMBOL) <span class="sc">%&gt;%</span> <span class="fu">summarise_each</span>(<span class="fu">funs</span>(mean)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">MHB=</span><span class="st">&quot;T&quot;</span>)</span>
<span id="cb29-166"><a href="figure-4.html#cb29-166" tabindex="-1"></a><span class="do">## LN</span></span>
<span id="cb29-167"><a href="figure-4.html#cb29-167" tabindex="-1"></a>scMethyl_MHB_LN_Mcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/GW/MHB_LN_extend_methylated.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-168"><a href="figure-4.html#cb29-168" tabindex="-1"></a>                            <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb29-169"><a href="figure-4.html#cb29-169" tabindex="-1"></a>scMethyl_MHB_LN_Tcounts <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;scMHB_GSE97693/Methyl/GW/MHB_LN_extend_total.txt&quot;</span>,<span class="at">header=</span>T) <span class="sc">%&gt;%</span> <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-170"><a href="figure-4.html#cb29-170" tabindex="-1"></a>                            <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>)</span>
<span id="cb29-171"><a href="figure-4.html#cb29-171" tabindex="-1"></a>scMethyl_MHB_LN_Tcounts[scMethyl_MHB_LN_Tcounts<span class="sc">&lt;</span><span class="dv">3</span>]<span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb29-172"><a href="figure-4.html#cb29-172" tabindex="-1"></a>scMethyl_MHB_LN <span class="ot">&lt;-</span> scMethyl_MHB_LN_Mcounts<span class="sc">/</span>scMethyl_MHB_LN_Tcounts </span>
<span id="cb29-173"><a href="figure-4.html#cb29-173" tabindex="-1"></a>scMethyl_MHB_LN <span class="ot">&lt;-</span> scMethyl_MHB_LN  <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;region&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">separate</span>(region,<span class="at">into=</span><span class="fu">c</span>(<span class="st">&quot;chr&quot;</span>,<span class="st">&quot;start&quot;</span>,<span class="st">&quot;end&quot;</span>),<span class="at">sep=</span><span class="st">&quot;[:-]&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb29-174"><a href="figure-4.html#cb29-174" tabindex="-1"></a>                         <span class="fu">mutate</span>(<span class="at">start=</span><span class="fu">as.numeric</span>(start)<span class="sc">-</span><span class="dv">1</span>,<span class="at">end=</span><span class="fu">as.numeric</span>(end))</span>
<span id="cb29-175"><a href="figure-4.html#cb29-175" tabindex="-1"></a>scMethyl_MHB_LN.GR <span class="ot">&lt;-</span> <span class="fu">makeGRangesFromDataFrame</span>(scMethyl_MHB_LN,<span class="at">keep.extra=</span>T)</span>
<span id="cb29-176"><a href="figure-4.html#cb29-176" tabindex="-1"></a></span>
<span id="cb29-177"><a href="figure-4.html#cb29-177" tabindex="-1"></a><span class="co"># overlapping</span></span>
<span id="cb29-178"><a href="figure-4.html#cb29-178" tabindex="-1"></a>x.LN <span class="ot">&lt;-</span> <span class="fu">findOverlaps</span>(promoter.GR,scMethyl_MHB_LN.GR,<span class="at">ignore.strand=</span>T)</span>
<span id="cb29-179"><a href="figure-4.html#cb29-179" tabindex="-1"></a>scMethyl_MHB_LN_TSS <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">mcols</span>(promoter.GR[<span class="fu">queryHits</span>(x.LN)])[<span class="st">&quot;SYMBOL&quot;</span>],<span class="fu">mcols</span>(scMethyl_MHB_LN.GR[<span class="fu">subjectHits</span>(x.LN)]))</span>
<span id="cb29-180"><a href="figure-4.html#cb29-180" tabindex="-1"></a>scMethyl_MHB_LN_TSS <span class="ot">&lt;-</span>  scMethyl_MHB_LN_TSS <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()  <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(SYMBOL) <span class="sc">%&gt;%</span> <span class="fu">summarise_each</span>(<span class="fu">funs</span>(mean)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">MHB=</span><span class="st">&quot;T&quot;</span>)</span>
<span id="cb29-181"><a href="figure-4.html#cb29-181" tabindex="-1"></a></span>
<span id="cb29-182"><a href="figure-4.html#cb29-182" tabindex="-1"></a>scMethyl_MHB_TSS <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;PT&quot;</span><span class="ot">=</span>scMethyl_MHB_PT_TSS,<span class="st">&quot;LN&quot;</span><span class="ot">=</span>scMethyl_MHB_LN_TSS)</span>
<span id="cb29-183"><a href="figure-4.html#cb29-183" tabindex="-1"></a><span class="co"># Find DM MHB</span></span>
<span id="cb29-184"><a href="figure-4.html#cb29-184" tabindex="-1"></a>DMHG.PT<span class="ot">&lt;-</span> <span class="fu">findDMGenes</span>(scMethyl_MHB_TSS,<span class="at">Idents=</span><span class="st">&quot;PT&quot;</span>) <span class="sc">%&gt;%</span>  <span class="fu">filter</span>(SYMBOL <span class="sc">%in%</span> geneset)</span>
<span id="cb29-185"><a href="figure-4.html#cb29-185" tabindex="-1"></a>DMHG.LN<span class="ot">&lt;-</span> <span class="fu">findDMGenes</span>(scMethyl_MHB_TSS,<span class="at">Idents=</span><span class="st">&quot;LN&quot;</span>) <span class="sc">%&gt;%</span>  <span class="fu">filter</span>(SYMBOL <span class="sc">%in%</span> geneset)</span>
<span id="cb29-186"><a href="figure-4.html#cb29-186" tabindex="-1"></a></span>
<span id="cb29-187"><a href="figure-4.html#cb29-187" tabindex="-1"></a><span class="co"># Step4: Geneset enrichment </span></span>
<span id="cb29-188"><a href="figure-4.html#cb29-188" tabindex="-1"></a><span class="fu">library</span>(rGREAT)</span>
<span id="cb29-189"><a href="figure-4.html#cb29-189" tabindex="-1"></a>gs <span class="ot">=</span> <span class="fu">read_gmt</span>(<span class="st">&quot;PT-LN.MHB.NonDMR.Up.gmt&quot;</span>, </span>
<span id="cb29-190"><a href="figure-4.html#cb29-190" tabindex="-1"></a>    <span class="at">from =</span> <span class="st">&quot;SYMBOL&quot;</span>, <span class="at">to =</span> <span class="st">&quot;ENTREZ&quot;</span>, <span class="at">orgdb =</span> <span class="st">&quot;org.Hs.eg.db&quot;</span>)</span>
<span id="cb29-191"><a href="figure-4.html#cb29-191" tabindex="-1"></a><span class="co">#library(clusterProfiler)</span></span>
<span id="cb29-192"><a href="figure-4.html#cb29-192" tabindex="-1"></a><span class="co">#library(msigdbr)</span></span>
<span id="cb29-193"><a href="figure-4.html#cb29-193" tabindex="-1"></a><span class="co"># Here we use Hallmark gene sets as an example:</span></span>
<span id="cb29-194"><a href="figure-4.html#cb29-194" tabindex="-1"></a><span class="co">#m_t2g &lt;- msigdbr(species = &quot;Homo sapiens&quot;, category = &quot;H&quot;) %&gt;% </span></span>
<span id="cb29-195"><a href="figure-4.html#cb29-195" tabindex="-1"></a><span class="co">#  dplyr::select(gs_name, entrez_gene)</span></span>
<span id="cb29-196"><a href="figure-4.html#cb29-196" tabindex="-1"></a><span class="co">#gene &lt;- gs$geneset</span></span>
<span id="cb29-197"><a href="figure-4.html#cb29-197" tabindex="-1"></a><span class="co">#em &lt;- enricher(gene, TERM2GENE=m_t2g,minGSSize=1)</span></span>
<span id="cb29-198"><a href="figure-4.html#cb29-198" tabindex="-1"></a><span class="co">#enrich.data&lt;- head(em) %&gt;% mutate(type=&quot;111&quot;,GeneRatio=c(0.2174,0.2609))</span></span>
<span id="cb29-199"><a href="figure-4.html#cb29-199" tabindex="-1"></a></span>
<span id="cb29-200"><a href="figure-4.html#cb29-200" tabindex="-1"></a><span class="co"># Result From Msigdb website</span></span>
<span id="cb29-201"><a href="figure-4.html#cb29-201" tabindex="-1"></a>msig <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ID=</span><span class="fu">c</span>(<span class="st">&quot;HALLMARK_MYC_TARGETS_V1&quot;</span>,<span class="st">&quot;HALLMARK_UNFOLDED_PROTEIN_RESPONSE&quot;</span>,<span class="st">&quot;HALLMARK_G2M_CHECKPOINT&quot;</span>),</span>
<span id="cb29-202"><a href="figure-4.html#cb29-202" tabindex="-1"></a>                  <span class="at">qvalue =</span> <span class="fu">c</span>(<span class="fl">5.21e-8</span>,<span class="fl">2.33e-6</span>,<span class="fl">5.67e-4</span>))</span>
<span id="cb29-203"><a href="figure-4.html#cb29-203" tabindex="-1"></a><span class="co"># PLOT</span></span>
<span id="cb29-204"><a href="figure-4.html#cb29-204" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(msig,<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">fct_rev</span>(<span class="fu">fct_inorder</span>(ID)),<span class="at">y=</span> <span class="sc">-</span><span class="fu">log10</span>(qvalue))) <span class="sc">+</span></span>
<span id="cb29-205"><a href="figure-4.html#cb29-205" tabindex="-1"></a>     <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">&quot;identity&quot;</span>,<span class="at">fill=</span><span class="st">&quot;steelblue&quot;</span>) <span class="sc">+</span></span>
<span id="cb29-206"><a href="figure-4.html#cb29-206" tabindex="-1"></a>     <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb29-207"><a href="figure-4.html#cb29-207" tabindex="-1"></a>     <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>,<span class="at">y=</span><span class="st">&quot;-Log10(FDR)&quot;</span>,<span class="at">title=</span><span class="st">&quot;Enrichment of hallmark pathways&quot;</span>) <span class="sc">+</span></span>
<span id="cb29-208"><a href="figure-4.html#cb29-208" tabindex="-1"></a>      <span class="fu">coord_flip</span>() <span class="sc">+</span> </span>
<span id="cb29-209"><a href="figure-4.html#cb29-209" tabindex="-1"></a>     <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb29-210"><a href="figure-4.html#cb29-210" tabindex="-1"></a>     <span class="fu">theme</span>(<span class="at">panel.grid=</span><span class="fu">element_blank</span>(),</span>
<span id="cb29-211"><a href="figure-4.html#cb29-211" tabindex="-1"></a>            <span class="at">panel.background =</span><span class="fu">element_blank</span>(),</span>
<span id="cb29-212"><a href="figure-4.html#cb29-212" tabindex="-1"></a>            <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="fl">0.5</span>),</span>
<span id="cb29-213"><a href="figure-4.html#cb29-213" tabindex="-1"></a>            <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">color=</span><span class="st">&quot;black&quot;</span>)</span>
<span id="cb29-214"><a href="figure-4.html#cb29-214" tabindex="-1"></a>            )</span>
<span id="cb29-215"><a href="figure-4.html#cb29-215" tabindex="-1"></a><span class="fu">ggsave</span>(p,<span class="at">filename=</span><span class="fu">paste0</span>(<span class="st">&quot;Data/Figures/Fig4/Fig4.I.pdf&quot;</span>),<span class="at">width=</span><span class="fl">6.5</span>,<span class="at">height=</span><span class="fl">1.5</span>)            </span>
<span id="cb29-216"><a href="figure-4.html#cb29-216" tabindex="-1"></a></span>
<span id="cb29-217"><a href="figure-4.html#cb29-217" tabindex="-1"></a><span class="co"># Step 5: show the 42 common genes are shared by PT and LN.</span></span>
<span id="cb29-218"><a href="figure-4.html#cb29-218" tabindex="-1"></a><span class="co"># RNA merging with DNA methylation matrix</span></span>
<span id="cb29-219"><a href="figure-4.html#cb29-219" tabindex="-1"></a>RNA.DEG.PT <span class="ot">&lt;-</span> PT.markers <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DEG<span class="sc">==</span><span class="st">&quot;Yes&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(SYMBOL <span class="sc">%in%</span> geneset)  <span class="sc">%&gt;%</span> <span class="fu">inner_join</span>(DMG.PT,<span class="at">by=</span><span class="st">&quot;SYMBOL&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="st">&quot;PT.FC&quot;</span><span class="ot">=</span><span class="st">&quot;logFC&quot;</span>,<span class="st">&quot;PT.delta&quot;</span><span class="ot">=</span><span class="st">&quot;delta&quot;</span>) <span class="sc">%&gt;%</span>  <span class="fu">select</span>(SYMBOL,PT.FC,PT.delta)</span>
<span id="cb29-220"><a href="figure-4.html#cb29-220" tabindex="-1"></a>RNA.DEG.LN <span class="ot">&lt;-</span> LN.markers <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DEG<span class="sc">==</span><span class="st">&quot;Yes&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(SYMBOL <span class="sc">%in%</span> geneset)  <span class="sc">%&gt;%</span> <span class="fu">inner_join</span>(DMG.LN,<span class="at">by=</span><span class="st">&quot;SYMBOL&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="st">&quot;LN.FC&quot;</span><span class="ot">=</span><span class="st">&quot;logFC&quot;</span>,<span class="st">&quot;LN.delta&quot;</span><span class="ot">=</span><span class="st">&quot;delta&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(SYMBOL,LN.FC,LN.delta)</span>
<span id="cb29-221"><a href="figure-4.html#cb29-221" tabindex="-1"></a>RNA.DEG <span class="ot">&lt;-</span> RNA.DEG.PT <span class="sc">%&gt;%</span> <span class="fu">inner_join</span>(RNA.DEG.LN,<span class="at">by=</span><span class="st">&quot;SYMBOL&quot;</span>)</span>
<span id="cb29-222"><a href="figure-4.html#cb29-222" tabindex="-1"></a></span>
<span id="cb29-223"><a href="figure-4.html#cb29-223" tabindex="-1"></a>log2.RNA <span class="ot">&lt;-</span> <span class="fu">log2</span>(RNA<span class="sc">+</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;SYMBOL&quot;</span>)</span>
<span id="cb29-224"><a href="figure-4.html#cb29-224" tabindex="-1"></a>Methyl <span class="ot">&lt;-</span> scMethyl <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>))</span>
<span id="cb29-225"><a href="figure-4.html#cb29-225" tabindex="-1"></a>data <span class="ot">&lt;-</span>  RNA.DEG <span class="sc">%&gt;%</span> <span class="fu">inner_join</span>(log2.RNA,<span class="at">by=</span><span class="st">&quot;SYMBOL&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb29-226"><a href="figure-4.html#cb29-226" tabindex="-1"></a>        <span class="fu">inner_join</span>(Methyl,<span class="at">by=</span><span class="st">&quot;SYMBOL&quot;</span>)</span>
<span id="cb29-227"><a href="figure-4.html#cb29-227" tabindex="-1"></a><span class="co"># RNA flag</span></span>
<span id="cb29-228"><a href="figure-4.html#cb29-228" tabindex="-1"></a>id.RNA.NC <span class="ot">&lt;-</span> id.RNA <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;NC&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-229"><a href="figure-4.html#cb29-229" tabindex="-1"></a>id.RNA.PT <span class="ot">&lt;-</span> id.RNA <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;PT&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-230"><a href="figure-4.html#cb29-230" tabindex="-1"></a>id.RNA.LN <span class="ot">&lt;-</span> id.RNA <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;LN&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-231"><a href="figure-4.html#cb29-231" tabindex="-1"></a>id.RNA.tag <span class="ot">&lt;-</span> <span class="fu">c</span>(id.RNA.NC,id.RNA.PT,id.RNA.LN)</span>
<span id="cb29-232"><a href="figure-4.html#cb29-232" tabindex="-1"></a><span class="co"># Methylation flag</span></span>
<span id="cb29-233"><a href="figure-4.html#cb29-233" tabindex="-1"></a>id.Met.NC <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;NC&quot;</span>,assay<span class="sc">==</span><span class="st">&quot;Met&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-234"><a href="figure-4.html#cb29-234" tabindex="-1"></a>id.Met.PT <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;PT&quot;</span>,assay<span class="sc">==</span><span class="st">&quot;Met&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-235"><a href="figure-4.html#cb29-235" tabindex="-1"></a>id.Met.LN <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;LN&quot;</span>,assay<span class="sc">==</span><span class="st">&quot;Met&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-236"><a href="figure-4.html#cb29-236" tabindex="-1"></a>id.Met.ML <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;ML&quot;</span>,assay<span class="sc">==</span><span class="st">&quot;Met&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-237"><a href="figure-4.html#cb29-237" tabindex="-1"></a>id.Met.MP <span class="ot">&lt;-</span> id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">==</span><span class="st">&quot;MP&quot;</span>,assay<span class="sc">==</span><span class="st">&quot;Met&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-238"><a href="figure-4.html#cb29-238" tabindex="-1"></a>id.Met.tag <span class="ot">&lt;-</span> <span class="fu">c</span>(id.Met.NC,id.Met.PT,id.Met.LN,id.Met.ML,id.Met.MP)</span>
<span id="cb29-239"><a href="figure-4.html#cb29-239" tabindex="-1"></a></span>
<span id="cb29-240"><a href="figure-4.html#cb29-240" tabindex="-1"></a><span class="fu">library</span>(ComplexHeatmap)</span>
<span id="cb29-241"><a href="figure-4.html#cb29-241" tabindex="-1"></a><span class="fu">library</span>(circlize)</span>
<span id="cb29-242"><a href="figure-4.html#cb29-242" tabindex="-1"></a><span class="co"># In tissue-level</span></span>
<span id="cb29-243"><a href="figure-4.html#cb29-243" tabindex="-1"></a>mhb_N_Tx <span class="ot">&lt;-</span> <span class="fu">toGRanges</span>(<span class="st">&quot;scMHB_GSE97693/MHB/BED/CRC_MHB_NC.bed&quot;</span>)  <span class="sc">%&gt;%</span> </span>
<span id="cb29-244"><a href="figure-4.html#cb29-244" tabindex="-1"></a>            <span class="fu">findOverlaps</span>(scMethyl.GR,<span class="at">ignore.strand=</span>T,<span class="at">type=</span> <span class="st">&quot;any&quot;</span>)</span>
<span id="cb29-245"><a href="figure-4.html#cb29-245" tabindex="-1"></a>mhb_N_genes <span class="ot">&lt;-</span> <span class="fu">mcols</span>(scMethyl.GR[<span class="fu">subjectHits</span>(mhb_N_Tx)]) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span>  <span class="fu">pull</span>(SYMBOL) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb29-246"><a href="figure-4.html#cb29-246" tabindex="-1"></a><span class="co"># mean signal</span></span>
<span id="cb29-247"><a href="figure-4.html#cb29-247" tabindex="-1"></a><span class="do">## RNA</span></span>
<span id="cb29-248"><a href="figure-4.html#cb29-248" tabindex="-1"></a>RNA.mean <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="st">&quot;PT&quot;</span>,<span class="st">&quot;LN&quot;</span>,<span class="st">&quot;NC&quot;</span>),<span class="cf">function</span>(x){</span>
<span id="cb29-249"><a href="figure-4.html#cb29-249" tabindex="-1"></a>     ID <span class="ot">&lt;-</span>  id.RNA <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">==</span>x) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-250"><a href="figure-4.html#cb29-250" tabindex="-1"></a>     RNA <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">contains</span>(ID)) <span class="sc">%&gt;%</span> <span class="fu">rowMeans</span>(<span class="at">na.rm=</span>T) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">rename_with</span>(<span class="sc">~</span>x)</span>
<span id="cb29-251"><a href="figure-4.html#cb29-251" tabindex="-1"></a>})</span>
<span id="cb29-252"><a href="figure-4.html#cb29-252" tabindex="-1"></a>RNA.data <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind,RNA.mean) <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;SYMBOL&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(SYMBOL <span class="sc">%in%</span> geneset) <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;SYMBOL&quot;</span>)</span>
<span id="cb29-253"><a href="figure-4.html#cb29-253" tabindex="-1"></a><span class="do">## Methylation</span></span>
<span id="cb29-254"><a href="figure-4.html#cb29-254" tabindex="-1"></a>Met.mean <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="st">&quot;PT&quot;</span>,<span class="st">&quot;LN&quot;</span>,<span class="st">&quot;ML&quot;</span>,<span class="st">&quot;MP&quot;</span>,<span class="st">&quot;NC&quot;</span>),<span class="cf">function</span>(x){</span>
<span id="cb29-255"><a href="figure-4.html#cb29-255" tabindex="-1"></a>     ID <span class="ot">&lt;-</span>  id <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tissue<span class="sc">==</span>x,assay<span class="sc">==</span><span class="st">&quot;Met&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(ID)</span>
<span id="cb29-256"><a href="figure-4.html#cb29-256" tabindex="-1"></a>     scMethyl <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>))  <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">contains</span>(ID)) <span class="sc">%&gt;%</span> <span class="fu">rowMeans</span>(<span class="at">na.rm=</span>T) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">rename_with</span>(<span class="sc">~</span>x)</span>
<span id="cb29-257"><a href="figure-4.html#cb29-257" tabindex="-1"></a>})</span>
<span id="cb29-258"><a href="figure-4.html#cb29-258" tabindex="-1"></a>Met.data <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind,Met.mean) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">cbind</span>(scMethyl[,<span class="dv">5</span>]) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(SYMBOL <span class="sc">%in%</span> geneset) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(SYMBOL) <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;SYMBOL&quot;</span>)</span>
<span id="cb29-259"><a href="figure-4.html#cb29-259" tabindex="-1"></a><span class="co"># PLOT 1 </span></span>
<span id="cb29-260"><a href="figure-4.html#cb29-260" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file=</span><span class="st">&quot;Data/Figures/Fig4/Fig4.J.pdf&quot;</span>,<span class="at">width=</span><span class="fl">4.5</span>,<span class="at">height=</span><span class="dv">7</span>)</span>
<span id="cb29-261"><a href="figure-4.html#cb29-261" tabindex="-1"></a><span class="co"># Annotation</span></span>
<span id="cb29-262"><a href="figure-4.html#cb29-262" tabindex="-1"></a><span class="do">## Methylation</span></span>
<span id="cb29-263"><a href="figure-4.html#cb29-263" tabindex="-1"></a>column_ha_1 <span class="ot">=</span> <span class="fu">HeatmapAnnotation</span>(<span class="at">Assay =</span> <span class="fu">rep</span>(<span class="st">&quot;WGBS&quot;</span>,<span class="dv">5</span>) , <span class="at">Type =</span> <span class="fu">names</span>(Met.data))</span>
<span id="cb29-264"><a href="figure-4.html#cb29-264" tabindex="-1"></a>row_ha_1 <span class="ot">=</span> <span class="fu">rowAnnotation</span>(<span class="at">MHB_PT =</span> <span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">42</span>),<span class="at">MHB_LN =</span> <span class="fu">rep</span>(<span class="dv">1</span>,<span class="dv">42</span>), <span class="at">MHB_NC=</span> <span class="fu">sapply</span>(<span class="fu">rownames</span>(Met.data),<span class="cf">function</span>(x) {<span class="fu">ifelse</span>(x <span class="sc">%in%</span> mhb_N_genes,<span class="dv">1</span>,<span class="dv">0</span>)}))</span>
<span id="cb29-265"><a href="figure-4.html#cb29-265" tabindex="-1"></a>colfun11 <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">&#39;darkblue&#39;</span>, <span class="st">&#39;white&#39;</span>, <span class="st">&#39;firebrick&#39;</span>))</span>
<span id="cb29-266"><a href="figure-4.html#cb29-266" tabindex="-1"></a><span class="do">## RNA</span></span>
<span id="cb29-267"><a href="figure-4.html#cb29-267" tabindex="-1"></a>column_ha_2 <span class="ot">=</span> <span class="fu">HeatmapAnnotation</span>(<span class="at">Assay =</span> <span class="fu">rep</span>(<span class="st">&quot;RNA&quot;</span>,<span class="dv">3</span>) , <span class="at">Type =</span> <span class="fu">names</span>(RNA.data) )</span>
<span id="cb29-268"><a href="figure-4.html#cb29-268" tabindex="-1"></a>colfun21 <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">4</span>), <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">&#39;darkblue&#39;</span>, <span class="st">&#39;white&#39;</span>, <span class="st">&#39;firebrick&#39;</span>))</span>
<span id="cb29-269"><a href="figure-4.html#cb29-269" tabindex="-1"></a>data.RNA.scale <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">scale</span>(<span class="fu">t</span>(<span class="fu">as.matrix</span>(RNA.data))))</span>
<span id="cb29-270"><a href="figure-4.html#cb29-270" tabindex="-1"></a></span>
<span id="cb29-271"><a href="figure-4.html#cb29-271" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(<span class="fu">as.matrix</span>(Met.data),<span class="at">name=</span><span class="st">&quot;Methylation&quot;</span>,</span>
<span id="cb29-272"><a href="figure-4.html#cb29-272" tabindex="-1"></a>                <span class="at">col=</span>colfun11,<span class="at">cluster_columns=</span> F,</span>
<span id="cb29-273"><a href="figure-4.html#cb29-273" tabindex="-1"></a>                <span class="at">cluster_rows=</span>F, <span class="at">left_annotation =</span> row_ha_1,</span>
<span id="cb29-274"><a href="figure-4.html#cb29-274" tabindex="-1"></a>                <span class="at">top_annotation =</span> column_ha_1)</span>
<span id="cb29-275"><a href="figure-4.html#cb29-275" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(<span class="fu">as.matrix</span>(data.RNA.scale ),<span class="at">name=</span><span class="st">&quot;TPM(scaled)&quot;</span>,</span>
<span id="cb29-276"><a href="figure-4.html#cb29-276" tabindex="-1"></a>                <span class="at">col=</span>colfun21,<span class="at">cluster_columns=</span> F,</span>
<span id="cb29-277"><a href="figure-4.html#cb29-277" tabindex="-1"></a>                 <span class="at">cluster_rows=</span>F,</span>
<span id="cb29-278"><a href="figure-4.html#cb29-278" tabindex="-1"></a>                <span class="at">top_annotation =</span> column_ha_2)</span>
<span id="cb29-279"><a href="figure-4.html#cb29-279" tabindex="-1"></a>p<span class="ot">&lt;-</span> p1<span class="sc">+</span>p2</span>
<span id="cb29-280"><a href="figure-4.html#cb29-280" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb29-281"><a href="figure-4.html#cb29-281" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-55"></span>
<img src="Data/Figures/Fig4/Fig4.I.png" alt="Fig4.I-J" width="40%" id="fig-unnamed-chunk-55-1" /><img src="Data/Figures/Fig4/Fig4.J.png" alt="Fig4.I-J" width="40%" id="fig-unnamed-chunk-55-2" />
<p class="caption">
 4.6: Fig4.I-J
</p>
</div>
</div>
<div id="k.-tcga-coad-dataset-validation" class="section level2 hasAnchor" number="4.7">
<h2><span class="header-section-number">4.7</span> (K). TCGA-COAD dataset Validation<a href="figure-4.html#k.-tcga-coad-dataset-validation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="figure-4.html#cb30-1" tabindex="-1"></a><span class="co"># TCGA COAD validation MYC target &amp; G2M  genes</span></span>
<span id="cb30-2"><a href="figure-4.html#cb30-2" tabindex="-1"></a><span class="co"># load DNAme data</span></span>
<span id="cb30-3"><a href="figure-4.html#cb30-3" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;TCGA_Promoter_Methylation_UD1000.RData&quot;</span>)</span>
<span id="cb30-4"><a href="figure-4.html#cb30-4" tabindex="-1"></a>MM_COAD <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">mcols</span>(Mregion)[<span class="st">&quot;name&quot;</span>],rList<span class="sc">$</span>COAD)</span>
<span id="cb30-5"><a href="figure-4.html#cb30-5" tabindex="-1"></a><span class="co"># load expression data</span></span>
<span id="cb30-6"><a href="figure-4.html#cb30-6" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;TCGA/Exp/Firehose_Expression.RData&quot;</span>)</span>
<span id="cb30-7"><a href="figure-4.html#cb30-7" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;TCGA/Exp/Firehose_SampleSheet.RData&quot;</span>)</span>
<span id="cb30-8"><a href="figure-4.html#cb30-8" tabindex="-1"></a>Exp_COAD <span class="ot">&lt;-</span> Firehose_Expression<span class="sc">$</span>COAD</span>
<span id="cb30-9"><a href="figure-4.html#cb30-9" tabindex="-1"></a><span class="co"># clinical data </span></span>
<span id="cb30-10"><a href="figure-4.html#cb30-10" tabindex="-1"></a>COAD_clinical <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&quot;TCGA/Clinical/gdac.broadinstitute.org_COAD.Merge_Clinical.Level_1.2016012800.0.0/COAD.merged_only_clinical_clin_format.txt&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-11"><a href="figure-4.html#cb30-11" tabindex="-1"></a>                <span class="fu">filter</span>(V1 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;patient.bcr_patient_barcode&quot;</span>,<span class="st">&quot;patient.stage_event.pathologic_stage&quot;</span>,<span class="st">&quot;patient.vital_status&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-12"><a href="figure-4.html#cb30-12" tabindex="-1"></a>                <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;V1&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb30-13"><a href="figure-4.html#cb30-13" tabindex="-1"></a>                <span class="fu">rename_with</span>(<span class="sc">~</span><span class="fu">c</span>(<span class="st">&quot;ID&quot;</span>,<span class="st">&quot;Stage&quot;</span>,<span class="st">&quot;status&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb30-14"><a href="figure-4.html#cb30-14" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">str_to_upper</span>(ID),<span class="at">Stage=</span><span class="fu">str_replace_all</span>(Stage,<span class="st">&quot;stage &quot;</span>,<span class="st">&quot;&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">str_to_upper</span>())</span>
<span id="cb30-15"><a href="figure-4.html#cb30-15" tabindex="-1"></a><span class="co"># Combine DNAme &amp; Exp &amp; clinical data</span></span>
<span id="cb30-16"><a href="figure-4.html#cb30-16" tabindex="-1"></a>match.id.COAD <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(MM_COAD)[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">str_sub</span>(<span class="dv">1</span>,<span class="dv">16</span>) ,<span class="fu">colnames</span>(Exp_COAD) <span class="sc">%&gt;%</span> <span class="fu">str_sub</span>(<span class="dv">1</span>,<span class="dv">16</span>))</span>
<span id="cb30-17"><a href="figure-4.html#cb30-17" tabindex="-1"></a>match.id.COAD <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="st">&quot;Tag&quot;</span> <span class="ot">=</span>match.id.COAD) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">str_sub</span>(Tag,<span class="dv">1</span>,<span class="dv">12</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb30-18"><a href="figure-4.html#cb30-18" tabindex="-1"></a>                <span class="fu">left_join</span>(COAD_clinical,<span class="at">by=</span><span class="st">&quot;ID&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-19"><a href="figure-4.html#cb30-19" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">Stage=</span><span class="fu">ifelse</span>(<span class="fu">str_detect</span>(Stage,<span class="st">&quot;III&quot;</span>),<span class="st">&quot;III&quot;</span>,</span>
<span id="cb30-20"><a href="figure-4.html#cb30-20" tabindex="-1"></a>                              <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(Stage,<span class="st">&quot;II&quot;</span>),<span class="st">&quot;II&quot;</span>,</span>
<span id="cb30-21"><a href="figure-4.html#cb30-21" tabindex="-1"></a>                              <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(Stage,<span class="st">&quot;IV&quot;</span>),<span class="st">&quot;IV&quot;</span>,</span>
<span id="cb30-22"><a href="figure-4.html#cb30-22" tabindex="-1"></a>                              <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(Stage,<span class="st">&quot;I&quot;</span>),<span class="st">&quot;I&quot;</span>,<span class="cn">NA</span>)))),</span>
<span id="cb30-23"><a href="figure-4.html#cb30-23" tabindex="-1"></a>                        <span class="at">Stage =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(Tag,<span class="st">&quot;-11&quot;</span>),<span class="st">&quot;Normal&quot;</span>,Stage)) <span class="sc">%&gt;%</span></span>
<span id="cb30-24"><a href="figure-4.html#cb30-24" tabindex="-1"></a>                        <span class="fu">na.omit</span>()</span>
<span id="cb30-25"><a href="figure-4.html#cb30-25" tabindex="-1"></a><span class="co"># signature selection</span></span>
<span id="cb30-26"><a href="figure-4.html#cb30-26" tabindex="-1"></a>signature <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;CBX3&quot;</span>,<span class="st">&quot;DDX21&quot;</span>,<span class="st">&quot;KARS&quot;</span>,<span class="st">&quot;KIF5B&quot;</span>,<span class="st">&quot;NOLC1&quot;</span>,<span class="st">&quot;PSMA7&quot;</span>,<span class="st">&quot;PSMB3&quot;</span>,<span class="st">&quot;RANBP1&quot;</span>,<span class="st">&quot;SLC12A2&quot;</span>,<span class="st">&quot;TOP1&quot;</span>)</span>
<span id="cb30-27"><a href="figure-4.html#cb30-27" tabindex="-1"></a>signature.me <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="st">&quot;I&quot;</span>,<span class="st">&quot;II&quot;</span>,<span class="st">&quot;III&quot;</span>,<span class="st">&quot;IV&quot;</span>,<span class="st">&quot;Normal&quot;</span>),<span class="cf">function</span>(x){</span>
<span id="cb30-28"><a href="figure-4.html#cb30-28" tabindex="-1"></a>            tag <span class="ot">&lt;-</span> match.id.COAD <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Stage<span class="sc">==</span>x) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Tag) <span class="sc">%&gt;%</span> <span class="fu">str_replace_all</span>(<span class="st">&quot;-&quot;</span>,<span class="st">&quot;.&quot;</span>)</span>
<span id="cb30-29"><a href="figure-4.html#cb30-29" tabindex="-1"></a>            MM_COAD <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">&quot;name&quot;</span>,<span class="fu">contains</span>(tag)) <span class="sc">%&gt;%</span> </span>
<span id="cb30-30"><a href="figure-4.html#cb30-30" tabindex="-1"></a>            <span class="fu">filter</span>(name <span class="sc">%in%</span> signature) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(name) <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;name&quot;</span>) <span class="sc">%&gt;%</span> <span class="fu">rowMeans</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb30-31"><a href="figure-4.html#cb30-31" tabindex="-1"></a>            <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Tag =</span> x,<span class="at">gene=</span>signature)</span>
<span id="cb30-32"><a href="figure-4.html#cb30-32" tabindex="-1"></a>})</span>
<span id="cb30-33"><a href="figure-4.html#cb30-33" tabindex="-1"></a>signature.me <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind,signature.me) <span class="sc">%&gt;%</span><span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(<span class="at">values_from=</span><span class="st">&quot;value&quot;</span>,<span class="at">names_from=</span><span class="st">&quot;Tag&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-34"><a href="figure-4.html#cb30-34" tabindex="-1"></a>            <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;gene&quot;</span>)</span>
<span id="cb30-35"><a href="figure-4.html#cb30-35" tabindex="-1"></a>signature.exp <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">c</span>(<span class="st">&quot;I&quot;</span>,<span class="st">&quot;II&quot;</span>,<span class="st">&quot;III&quot;</span>,<span class="st">&quot;IV&quot;</span>,<span class="st">&quot;Normal&quot;</span>),<span class="cf">function</span>(x){</span>
<span id="cb30-36"><a href="figure-4.html#cb30-36" tabindex="-1"></a>           tag <span class="ot">&lt;-</span> match.id.COAD <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Stage<span class="sc">==</span>x) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Tag) </span>
<span id="cb30-37"><a href="figure-4.html#cb30-37" tabindex="-1"></a>           <span class="do">## to TPM </span></span>
<span id="cb30-38"><a href="figure-4.html#cb30-38" tabindex="-1"></a>           temp <span class="ot">&lt;-</span> Exp_COAD <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">contains</span>(tag)) <span class="sc">%&gt;%</span> <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;name&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-39"><a href="figure-4.html#cb30-39" tabindex="-1"></a>                    <span class="fu">filter</span>(name <span class="sc">%in%</span> signature) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(name) <span class="sc">%&gt;%</span> <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;name&quot;</span>) </span>
<span id="cb30-40"><a href="figure-4.html#cb30-40" tabindex="-1"></a>           tpm  <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">^</span>(temp)<span class="sc">-</span><span class="dv">1</span> </span>
<span id="cb30-41"><a href="figure-4.html#cb30-41" tabindex="-1"></a>           tpm  <span class="sc">%&gt;%</span>  <span class="fu">rowMeans</span>() <span class="sc">%&gt;%</span>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Tag =</span> x,<span class="at">gene=</span>signature)</span>
<span id="cb30-42"><a href="figure-4.html#cb30-42" tabindex="-1"></a>})</span>
<span id="cb30-43"><a href="figure-4.html#cb30-43" tabindex="-1"></a>signature.exp <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind,signature.exp) <span class="sc">%&gt;%</span><span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">pivot_wider</span>(<span class="at">values_from=</span><span class="st">&quot;value&quot;</span>,<span class="at">names_from=</span><span class="st">&quot;Tag&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-44"><a href="figure-4.html#cb30-44" tabindex="-1"></a>                 <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">&quot;gene&quot;</span>)</span>
<span id="cb30-45"><a href="figure-4.html#cb30-45" tabindex="-1"></a><span class="co"># PLOT 2</span></span>
<span id="cb30-46"><a href="figure-4.html#cb30-46" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file=</span><span class="st">&quot;Data/Figures/Fig4/Fig4.K.pdf&quot;</span>,<span class="at">width=</span><span class="fl">4.5</span>,<span class="at">height=</span><span class="fl">2.5</span>)</span>
<span id="cb30-47"><a href="figure-4.html#cb30-47" tabindex="-1"></a><span class="co"># Annotation</span></span>
<span id="cb30-48"><a href="figure-4.html#cb30-48" tabindex="-1"></a><span class="do">## Methylation</span></span>
<span id="cb30-49"><a href="figure-4.html#cb30-49" tabindex="-1"></a>column_ha_1 <span class="ot">=</span> <span class="fu">HeatmapAnnotation</span>(<span class="at">Type =</span> <span class="fu">paste0</span>(<span class="st">&quot;Stage &quot;</span>,<span class="fu">names</span>(signature.me)))</span>
<span id="cb30-50"><a href="figure-4.html#cb30-50" tabindex="-1"></a>colfun11 <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">&#39;darkblue&#39;</span>, <span class="st">&#39;white&#39;</span>, <span class="st">&#39;firebrick&#39;</span>))</span>
<span id="cb30-51"><a href="figure-4.html#cb30-51" tabindex="-1"></a><span class="do">## RNA</span></span>
<span id="cb30-52"><a href="figure-4.html#cb30-52" tabindex="-1"></a>column_ha_2 <span class="ot">=</span> <span class="fu">HeatmapAnnotation</span>(<span class="at">Type =</span> <span class="fu">paste0</span>(<span class="st">&quot;Stage &quot;</span>,<span class="fu">names</span>(signature.exp) ))</span>
<span id="cb30-53"><a href="figure-4.html#cb30-53" tabindex="-1"></a>colfun21 <span class="ot">&lt;-</span> <span class="fu">colorRamp2</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">&#39;darkblue&#39;</span>, <span class="st">&#39;white&#39;</span>, <span class="st">&#39;firebrick&#39;</span>))</span>
<span id="cb30-54"><a href="figure-4.html#cb30-54" tabindex="-1"></a>data.RNA.scale <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">scale</span>(<span class="fu">t</span>(<span class="fu">as.matrix</span>(signature.exp))))</span>
<span id="cb30-55"><a href="figure-4.html#cb30-55" tabindex="-1"></a></span>
<span id="cb30-56"><a href="figure-4.html#cb30-56" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(<span class="fu">as.matrix</span>(signature.me),<span class="at">name=</span><span class="st">&quot;Methylation&quot;</span>,</span>
<span id="cb30-57"><a href="figure-4.html#cb30-57" tabindex="-1"></a>                <span class="at">col=</span>colfun11,<span class="at">cluster_columns=</span> F,</span>
<span id="cb30-58"><a href="figure-4.html#cb30-58" tabindex="-1"></a>                <span class="at">cluster_rows=</span>F, </span>
<span id="cb30-59"><a href="figure-4.html#cb30-59" tabindex="-1"></a>                <span class="at">top_annotation =</span> column_ha_1)</span>
<span id="cb30-60"><a href="figure-4.html#cb30-60" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">Heatmap</span>(<span class="fu">as.matrix</span>(data.RNA.scale ),<span class="at">name=</span><span class="st">&quot;TPM(scaled)&quot;</span>,</span>
<span id="cb30-61"><a href="figure-4.html#cb30-61" tabindex="-1"></a>                <span class="at">col=</span>colfun21,<span class="at">cluster_columns=</span> F,</span>
<span id="cb30-62"><a href="figure-4.html#cb30-62" tabindex="-1"></a>                 <span class="at">cluster_rows=</span>F,</span>
<span id="cb30-63"><a href="figure-4.html#cb30-63" tabindex="-1"></a>                <span class="at">top_annotation =</span> column_ha_2)</span>
<span id="cb30-64"><a href="figure-4.html#cb30-64" tabindex="-1"></a>p<span class="ot">&lt;-</span> p1<span class="sc">+</span>p2</span>
<span id="cb30-65"><a href="figure-4.html#cb30-65" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb30-66"><a href="figure-4.html#cb30-66" tabindex="-1"></a><span class="fu">dev.off</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-57"></span>
<img src="Data/Figures/Fig4/Fig4.K.png" alt="Fig4.K" width="80%" id="fig-unnamed-chunk-57-1" />
<p class="caption">
 4.7: Fig4.K
</p>
</div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="figure-3.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="figure-5.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/03-method.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown-demo.pdf", "bookdown-demo.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
